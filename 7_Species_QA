#################### Version Control ####################
# R version 3.2.2 (2015-08-14): Fire Safety 
# platform       x86_64-w64-mingw32 (64-bit)
############### Script Info ###############
# This is Script 7 of 9
# We now correct the biological data for each of the surveys
# AUTHOR: Meadhbh Moriarty, 2016
# REVIEWED BY: 

# PURPOSE:
# 1. Select relevant hauls within standard survey protocol
# 2. Select only fish in 
#      Phylum Chordata  
#       Classes:  Actinopteri
#                  Elasmobranchii 
#                  Holocephali 
#                  Myxini 
#                  Petromyzonti
# 3. Correct known errors in the biological files
# 4. Make global changes to the data, eg standardise length codes used.
# 5. Prepare BASELINE DATA (All steps except k-NN)
############# PACKAGES #############
list<-c("ggplot2", "data.table", "reshape2", "arm","car", "DMwR", "lme4", "plyr",
        "marmap", "plotrix", "colorspace", "plot3D", "plot3D", "rgl","MuMIn",
        "mapplots", "class")
lapply(list, require, character.only=T)
################# HouseKeeping #################
#boost memory for species stuff
memory.size(10000000000000)
memory.limit()
###############################
### Prepration of fish data ###
###############################
# Check the Hauls and HL1 file match
# now select the hauls and HL files that match up given the new unique IDS
checkhaul<-unique(hauls$New_UniqueID)
checkhl1<-unique(HL1$New_UniqueID)
# this gives 45919 hauls - same as HH hauls file
setdiff(checkhl1, checkhaul)
setdiff(checkhaul, checkhl1)
# All New_UniqueID match - good news as I'll need to merge both together 
########################### 
# 4.2.2 Initial Screening #
###########################
# Step 1: Resolving Species unique ID is in a seperate code - requires different 
# version of R
# I need to bring in an external file of preprepared fish life history info and 
# taxonomic resolution data
traits<-read.csv("./Raw_Data/Fish_traits_products/Species_List_Final.csv")
# This file contains information about the Classes of fish that we are interested in
#########################
# Combine relevant data #
#########################
# Step 2: merge haul data and LFD (HL1) data by "New_Unique ID"
# I need to know if how the data has been counted
# this info is in the haul file
# I also need the swept area estimates (in haul file)
dat1 <- merge(HL1, hauls, by="New_UniqueID")
# check no rows are added
nrow(HL1)-nrow(dat1)
dat1<-as.data.frame(dat1)
####################
# Select Fish Only #
####################
# Step 3: merge data and traits by "ValidAphiaID"
dat2<-merge(dat1, traits, by="ValidAphiaID")
names(dat1)
# check no rows are added
nrow(dat1)-nrow(dat2)
# Step4: remove all non fish data that we are not using in product
dat3<-subset(dat2, phylum=="Chordata",)
nrow(dat2)-nrow(dat3)
# dat3 is a copy of dat2 
names(dat2)
# Check that all hauls are retained?
checkhaul<-unique(hauls1$New_UniqueID)
checkdat2<-unique(dat2$New_UniqueID)
# this gives 45919 hauls - same as HH hauls file
setdiff(checkdat2, checkhaul)
list<-setdiff(checkhaul, checkdat3)
# two hauls contained no fish species - remove from hauls data
hauls1<-subset(hauls, !New_UniqueID%in%list,)
checkhaul<-unique(hauls1$New_UniqueID)
checkdat3<-unique(dat2$New_UniqueID)
setdiff(checkhaul, checkdat3)
# write a table to save the all the information
write.table(hauls1, "Haul_Information_05-10-2016.csv", sep=",")
write.table(dat2, "Fish_Species_Data_05_10_2016.csv", sep=",") 
str(kNN_GNSFraOT4)
dat2<-read.csv("Fish_Species_Data_05_10_2016.csv")
names(dat2)
# remove any SpecVal==0, these P/A values are rubbish - connect to the CA records
find<-subset(dat2, SpecVal==0, )  
# no O SpecVal
summary(dat2$phylum)

# select columns of interest and set up col type
keepers<-c("ValidAphiaID","New_UniqueID", "Survey.x","Quarter.x","Country.x",
           "Ship.x","Gear.x","StNo.x", "HaulNo.x", "Year.x","SpecCodeType",
           "SpecCode","SpecVal","Sex","TotalNo","CatIdentifier","NoMeas",  
           "SubWgt","CatCatchWgt","LngtCode","LngtClass", "HLNoAtLngt", "HaulDur",
           "DayNight","ShootLat","ShootLong","StatRec","HaulVal","StdSpecRecCode",
           "BycSpecRecCode", "DataType", "month", "DepthNew","SweptArea_wing_m_sqrd",
           "SweptArea_wing_km_sqrd", "valid_name","CLASS",                     
           "order","family","genus","rank","FRS_Common.Name","LmaxFB","LWRa","SubFactor") 
dat3<-as.data.table(dat2)
summary(dat2$HLNoAtLngt)
summary(dat2$TotalNo)
dat3<-dat2[keepers]
summary(dat3$HLNoAtLngt)
summary(dat3$TotalNo)
dat3<-subset(dat3,
             select=c(ValidAphiaID, New_UniqueID, Survey.x, Quarter.x, Country.x,
                     Ship.x, Gear.x, StNo.x, HaulNo.x, Year.x, SpecCodeType,
                     SpecCode, SpecVal, Sex, TotalNo, CatIdentifier, NoMeas,  
                     SubWgt, CatCatchWgt, LngtCode, LngtClass, HLNoAtLngt, HaulDur,
                     DayNight, ShootLat, ShootLong, StatRec, HaulVal, StdSpecRecCode,
                     BycSpecRecCode, DataType, month, DepthNew, SweptArea_wing_m_sqrd,
                     SweptArea_wing_km_sqrd, valid_name, CLASS,                     
                     order, family, genus, rank, LmaxFB, LWRa,SubFactor))
#remove the .x part of the names
dat3$Survey<-dat3$Survey.x
dat3$Quarter<-dat3$Quarter.x
dat3$Country<-dat3$Country.x
dat3$Ship<-dat3$Ship.x
dat3$Gear<-dat3$Gear.x
dat3$StNo<-dat3$StNo.x
dat3$HaulNo<-dat3$HaulNo.x
dat3$Year<-dat3$Year.x

dat3$Survey.x<-NULL
dat3$Quarter.x<-NULL
dat3$Country.x<-NULL
dat3$Ship.x<-NULL
dat3$Gear.x<-NULL
dat3$StNo.x<-NULL
dat3$HaulNo.x<-NULL
dat3$Year.x<-NULL
# set up numeric cols
str(dat3)
#dat3<-as.data.table(dat3)
#numCols <- c("HaulNo", "HaulDur", "ShootLat", "ShootLong", "DepthNew","TotalNo",
#             "NoMeas","SubWgt","CatCatchWgt","LngtClass", "HLNoAtLngt",
#             "SweptArea_wing_m_sqrd","SweptArea_wing_km_sqrd","LmaxFB","LWRa")
#dat3[, (numCols) := lapply(.SD, as.numeric), .SDcols = numCols]
############################## 
# 4.2.2 Taxonomic ID protocol#
##############################
# How many codes are species, genus, family
summary(as.factor(dat3$rank))
#Family      Genus    Species   Suborder Subspecies 
#15854      29356    5116152         84        268 
# Retain spp/subspp records that we trust
dat3$estrank[dat3$rank=="Species"]<-"Species"
dat3$estsciname<-dat3$valid_name
dat3$estAphia_Code[dat3$rank=="Species"]<-dat3$ValidAphiaID[dat3$rank=="Species"]
dat3$SpeciesQualityCode[dat3$rank=="Species"]<-"Recorded_Data"
dat3$estrank[dat3$rank=="Subspecies"]<-"Subspecies"
dat3$estAphia_Code[dat3$rank=="Subspecies"]<-dat3$ValidAphiaID[dat3$rank=="Subspecies"]
dat3$SpeciesQualityCode[dat3$rank=="Subspecies"]<-"Recorded_Data"
# M.M: Are these the most approperiate taxonomic resolutions for these fish?
# Suborder 
suborder<-subset(dat3, rank=="Suborder",)
summary(as.factor(suborder$valid_name))
# D.P: Gobioidei could be more approperiatly called Gobiidae
dat3$estsciname[dat3$valid_name=="Gobioidei"]<-"Gobiidae"
dat3$estrank[dat3$valid_name=="Gobioidei"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Gobiidae"]<-125537
dat3$SpeciesQualityCode[dat3$valid_name=="Gobioidei"]<-"suborder_to_family"
# M.M:What records have genus names when there is only one possible solution to species names
########################################################
# Resolve famliy/genus to species                     ##
# One species in the genus/family recoreded in survey ##
########################################################
# all Anguillidae and Anguilla to Anguilla anguilla
dat3$estsciname[dat3$valid_name=="Anguillidae"]<-"Anguilla anguilla"
dat3$estrank[dat3$valid_name=="Anguillidae"]<-"Species"
dat3$estsciname[dat3$valid_name=="Anguilla"]<-"Anguilla anguilla"
dat3$estrank[dat3$valid_name=="Anguilla"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Anguilla anguilla"]<-126281
dat3$SpeciesQualityCode[dat3$valid_name=="Anguilla"]<-"Genus_to_spp"
dat3$SpeciesQualityCode[dat3$valid_name=="Anguillidae"]<-"Family_to_spp"
# all Conger to conger conger
dat3$estsciname[dat3$valid_name=="Conger"]<-"Conger conger"
dat3$estrank[dat3$valid_name=="Conger"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Conger conger"]<-126285
dat3$SpeciesQualityCode[dat3$valid_name=="Conger"]<-"Genus_to_spp"
# all Engraulis to Engraulis encrasicolus
dat3$estsciname[dat3$valid_name=="Engraulis"]<-"Engraulis encrasicolus"
dat3$estrank[dat3$valid_name=="Engraulis"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Engraulis encrasicolus"]<-126426
dat3$SpeciesQualityCode[dat3$valid_name=="Engraulis"]<-"Genus_to_spp"
# all Merlucciidae to Merluccius merluccius
dat3$estsciname[dat3$valid_name=="Merlucciidae"]<-"Merluccius merluccius"
dat3$estrank[dat3$valid_name=="Merlucciidae"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Merluccius merluccius"]<-126484
dat3$SpeciesQualityCode[dat3$valid_name=="Merlucciidae"]<-"Family_to_spp"
# all Caproidaeto Capros aper
dat3$estsciname[dat3$valid_name=="Caproidae"]<-"Capros aper"
dat3$estrank[dat3$valid_name=="Caproidae"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Capros aper"]<-127419
dat3$SpeciesQualityCode[dat3$valid_name=="Caproidae"]<-"Family_to_spp"
# all Eutrigla to Eutrigla gurnardus
dat3$estsciname[dat3$valid_name=="Eutrigla"]<-"Eutrigla gurnardus"
dat3$estrank[dat3$valid_name=="Eutrigla"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Eutrigla gurnardus"]<-150637
dat3$SpeciesQualityCode[dat3$valid_name=="Eutrigla"]<-"Genus_to_spp"
# all Trigla to Trigla lyra
dat3$estsciname[dat3$valid_name=="Trigla"]<-"Trigla lyra"
dat3$estrank[dat3$valid_name=="Trigla"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Trigla lyra"]<-127266
dat3$SpeciesQualityCode[dat3$valid_name=="Trigla"]<-"Genus_to_spp"
# all Trigloporus to Trigloporus lastoviza
dat3$estsciname[dat3$valid_name=="Trigloporus"]<-"Trigloporus lastoviza"
dat3$estrank[dat3$valid_name=="Trigloporus"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Trigloporus lastoviza"]<-154462
dat3$SpeciesQualityCode[dat3$valid_name=="Trigloporus"]<-"Genus_to_spp"
# all Stomias to Stomias boa boa
find<-subset(dat3, dat3$genus=="Stomias",)
# Stomias boa ferox doesnt occur in North Sea so its going to be S.boa  
# for the BTS record at genus level (only 1 at genus level)
dat3$estsciname[dat3$valid_name=="Stomias"]<-"Stomias boa boa"
dat3$estrank[dat3$valid_name=="Stomias"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Stomias boa boa"]<-469202
dat3$SpeciesQualityCode[dat3$valid_name=="Stomias"]<-"Genus_to_spp"
# all Lampetra to Lampetra fluviatilis
find<-dat3[dat3$genus=="Lampetra",]
# summary(as.factor(find$valid_name))
# All the Lampetra records are gone/changed at source
dat3$estsciname[dat3$valid_name=="Lampetra"]<-"Lampetra fluviatilis"
dat3$estrank[dat3$valid_name=="Lampetra"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Lampetra fluviatilis"]<-101172
dat3$SpeciesQualityCode[dat3$valid_name=="Lampetra"]<-"Genus_to_spp"
# all Petromyzon to Petromyzon marinus
find<-dat3[dat3$genus=="Petromyzon",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Petromyzon"]<-"Petromyzon marinus"
dat3$estrank[dat3$valid_name=="Petromyzon"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Petromyzon marinus"]<-101174
dat3$SpeciesQualityCode[dat3$valid_name=="Petromyzon"]<-"Genus_to_spp"
# all Echiichthys to Echiichthys vipera
find<-dat3[dat3$genus=="Echiichthys",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Echiichthys"]<-"Echiichthys vipera"
dat3$estrank[dat3$valid_name=="Echiichthys"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Echiichthys vipera"]<-150630
dat3$SpeciesQualityCode[dat3$valid_name=="Echiichthys"]<-"Genus_to_spp"
# all Pegusa to Pegusa lascaris
find<-dat3[dat3$genus=="Pegusa",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Pegusa"]<-"Pegusa lascaris"
dat3$estrank[dat3$valid_name=="Pegusa"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Pegusa lascaris"]<-127156
dat3$SpeciesQualityCode[dat3$valid_name=="Pegusa"]<-"Genus_to_spp"
# Cyclopteridae to Cyclopteruslumpus
find<-dat3[dat3$family=="Cyclopteridae",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Cyclopteridae"]<-"Cyclopterus lumpus"
dat3$estrank[dat3$valid_name=="Cyclopteridae"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Cyclopterus lumpus"]<-127214
dat3$SpeciesQualityCode[dat3$valid_name=="Cyclopteridae"]<-"Family_to_spp"
# Gonostoma  to Gonostomaelongatum
find<-dat3[dat3$genus=="Gonostoma",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Gonostoma"]<-"Gonostoma elongatum"
dat3$estrank[dat3$valid_name=="Gonostoma"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Gonostoma elongatum"]<-127296
dat3$SpeciesQualityCode[dat3$valid_name=="Gonostoma"]<-"Genus_to_spp"
# Hygophum to Hygophum benoiti
find<-dat3[dat3$genus=="Hygophum",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Hygophum"]<-"Hygophum benoiti"
dat3$estrank[dat3$valid_name=="Hygophum"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Hygophum benoiti"]<-126602
dat3$SpeciesQualityCode[dat3$valid_name=="Hygophum"]<-"Genus_to_spp"
# Lepadogaster to Lepadogaster lepadogaster
find<-dat3[dat3$genus=="Lepadogaster",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Lepadogaster"]<-"Lepadogaster lepadogaster"
dat3$estrank[dat3$valid_name=="Lepadogaster"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Lepadogaster lepadogaster"]<-126518
dat3$SpeciesQualityCode[dat3$valid_name=="Lepadogaster"]<-"Genus_to_spp"
# Lithognathus to Lithognathus mormyrus
find<-dat3[dat3$genus=="Lithognathus",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Lithognathus"]<-"Lithognathus mormyrus"
dat3$estrank[dat3$valid_name=="Lithognathus"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Lithognathus mormyrus"]<-127055
dat3$SpeciesQualityCode[dat3$valid_name=="Lithognathus"]<-"Genus_to_spp"
#  Lumpenus to Lumpenus lampretaeformis
# find<-dat3[dat3$genus=="Lumpenus"]
# summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Lumpenus"]<-"Lumpenus lampretaeformis"
dat3$estrank[dat3$valid_name=="Lumpenus"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Lumpenus lampretaeformis"]<-154675
dat3$SpeciesQualityCode[dat3$valid_name=="Lumpenus"]<-"Genus_to_spp"
#  Macroramphosus to Macroramphosus scolopax
# find<-dat3[dat3$genus=="Macroramphosus"]
# summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Macroramphosus"]<-"Macroramphosus scolopax"
dat3$estrank[dat3$valid_name=="Macroramphosus"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Macroramphosus scolopax"]<-127378
dat3$SpeciesQualityCode[dat3$valid_name=="Macroramphosus"]<-"Genus_to_spp"
# Myctophum 
# find<-dat3[dat3$genus=="Myctophum"]
# summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Myctophum"]<-"Myctophum punctatum"
dat3$estrank[dat3$valid_name=="Myctophum"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Myctophum punctatum"]<-126627
dat3$SpeciesQualityCode[dat3$valid_name=="Myctophum"]<-"Genus_to_spp"
#Nansenia
#find<-dat3[dat3$genus=="Nansenia"]
#summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Nansenia"]<-"Nansenia tenera"
dat3$estrank[dat3$valid_name=="Nansenia"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Nansenia tenera"]<-126729
dat3$SpeciesQualityCode[dat3$valid_name=="Nansenia"]<-"Genus_to_spp"
#Pholidae
#find<-dat3[dat3$family=="Pholidae"]
#summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Pholidae"]<-"Pholis gunnellus"
dat3$estrank[dat3$valid_name=="Pholidae"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Pholis gunnellus"]<-126996
dat3$SpeciesQualityCode[dat3$valid_name=="Pholidae"]<-"Family_to_spp"
#Triglops
#find<-dat3[dat3$genus=="Triglops"]
#summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Triglops"]<-"Triglops murrayi"
dat3$estrank[dat3$valid_name=="Triglops"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Triglops murrayi"]<-127205
dat3$SpeciesQualityCode[dat3$valid_name=="Triglops"]<-"Genus_to_spp"
# Pegusa
dat3$estsciname[dat3$valid_name=="Pegusa"]<-"Pegusa lascaris"
dat3$estrank[dat3$valid_name=="Pegusa"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Pegusa lascaris"]<-127156
dat3$SpeciesQualityCode[dat3$valid_name=="Pegusa"]<-"Genus_to_spp"
# Balistes to Balistes capriscus
find<-dat3[dat3$genus=="Balistes"]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Balistes"]<-"Balistes capriscus"
dat3$estrank[dat3$valid_name=="Balistes"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Balistes capriscus"]<-154721
dat3$SpeciesQualityCode[dat3$valid_name=="Balistes"]<-"Genus_to_spp"
# Benthosema to Benthosema glaciale
find<-dat3[dat3$genus=="Benthosema"]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Benthosema"]<-"Benthosema glaciale"
dat3$estrank[dat3$valid_name=="Benthosema"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Benthosema glaciale"]<-126580
dat3$SpeciesQualityCode[dat3$valid_name=="Benthosema"]<-"Genus_to_spp"
# Notacanthidae will be Notacanthus bonaparte
find<-dat3[dat3$family=="Notacanthidae"]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Notacanthidae"]<-"Notacanthus bonaparte"
dat3$estrank[dat3$valid_name=="Notacanthidae"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Notacanthus bonaparte"]<-126642
dat3$SpeciesQualityCode[dat3$estsciname=="Notacanthus bonaparte"]<-"Genus_to_spp"
# Buglossidium will be Buglossidium lutem
find<-dat3[dat3$genus=="Buglossidium"]
unique(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Buglossidium"]<-"Buglossidium luteum"
dat3$estrank[dat3$valid_name=="Buglossidium"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Buglossidium luteum"]<-127153 
dat3$SpeciesQualityCode[dat3$estsciname=="Buglossidium luteum"]<-"Genus_to_spp"
###################
# Keep Genus Name #
###################
# Origionally all Lampadena to were to go to Lampadena urophaos atlantica (221500)
# But changes in the Spanish data set now no longer support that
# Retain all Lampadena at Genus level code 
find<-dat3[dat3$genus=="Lampadena",]
summary(as.factor(find$valid_name))
dat3$estsciname[dat3$valid_name=="Lampadena"]<-"Lampadena"
dat3$estrank[dat3$valid_name=="Lampadena"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Lampadena"]<-dat3$ValidAphiaID[dat3$estsciname=="Lampadena"]
dat3$SpeciesQualityCode[dat3$valid_name=="Lampadena"]<-"Recorded_Data"
# Breviraja - never been identified to species level - retain as genus
# Now removed from dataset
#find<-dat3[dat3$genus=="Breviraja",]
#summary(as.factor(find$valid_name))
#dat3$estsciname[dat3$valid_name=="Breviraja"]<-"Breviraja"
#dat3$estrank[dat3$valid_name=="Breviraja"]<-"Genus"
#dat3$estAphia_Code[dat3$estsciname=="Breviraja"]<-158545
#dat3$SpeciesQualityCode[dat3$estsciname=="Breviraja"]<-"Genus"
# Chiasmodon - only one record in entire data set 
find<-dat3[dat3$genus=="Chiasmodon",]
dat3$estsciname[dat3$valid_name=="Chiasmodon"]<-"Chiasmodon"
dat3$estrank[dat3$valid_name=="Chiasmodon"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Chiasmodon"]<-125956
dat3$SpeciesQualityCode[dat3$estsciname=="Chiasmodon"]<-"Recorded_Data"
# Cyclothone - only 2 records in entire data set 
dat3$estsciname[dat3$valid_name=="Cyclothone"]<-"Cyclothone"
dat3$estrank[dat3$valid_name=="Cyclothone"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Cyclothone"]<-126187
dat3$SpeciesQualityCode[dat3$estsciname=="Cyclothone"]<-"Recorded_Data"
# Melamphaes    no longer in database
#find<-dat3[dat3$genus=="Melamphaes",]
#dat3$estsciname[dat3$valid_name=="Melamphaes"]<-"Melamphaes"
#dat3$estrank[dat3$valid_name=="Melamphaes"]<-"Genus"
#dat3$estAphia_Code[dat3$estsciname=="Melamphaes"]<-126181
#dat3$SpeciesQualityCode[dat3$estsciname=="Melamphaes"]<-"Recorded_Data"
#################################
#Aggragate to Genus/Family Level#
#################################
# all sandeels to Ammodytidae
# Ammodytes, A.marinus, A.tobianus 
# Hyperoplus, H. immaculatus, H. lanceolatus
# Gymnammodytes semisquamatus   
# Gymnammodytes cicerelus
find<-dat3[dat3$family=="Ammodytidae",]
summary(as.factor(find$rank))
summary(as.factor(find$valid_name))
# 1911+2758, #4669+19231, 4669/23900
# 19.5% needs resolved to species level BUT huge length inconsistancys meaning
# species are likeley to be poorly identified
dat3$estsciname[dat3$family=="Ammodytidae"]<-"Ammodytidae"
dat3$estrank[dat3$family=="Ammodytidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Ammodytidae"]<-125516
dat3$SpeciesQualityCode[dat3$estsciname=="Ammodytidae"]<-"spp/genus_to_family"
dat3$SpeciesQualityCode[dat3$valid_name=="Ammodytidae"]<-"Recorded_Data"
# All Gobies to Family Level
find<-dat3[dat3$family=="Gobiidae"]
summary(as.factor(find$valid_name))
summary(as.factor(find$rank))
#3958 +4775, # 8733+12319, #8733/21052
# 41.5% needs resolved to species level BUT huge length inconsistancys meaning
# species are likeley to be poorly identified
dat3$estsciname[dat3$family=="Gobiidae"]<-"Gobiidae"
dat3$estrank[dat3$family=="Gobiidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Gobiidae"]<-125537
dat3$SpeciesQualityCode[dat3$family=="Gobiidae"]<-"spp/genus_to_family"
dat3$SpeciesQualityCode[dat3$valid_name=="Gobiidae"]<-"Recorded_Data"
###########################
# Resolve family to genus #
# Minimise codes for      #
# further resolution      #
###########################
# 64 taxonomic groups which need to be assigned a species level code across all surveys
# some of these groups are 2 codes that essentially mean the same thing, 
# eg. Callionymidae and Callionymus
# no need to look at these Callionymidae seperately to the Callionymus 
# in Knn resolution later on
# Mullidae to Mullus
dat3$estsciname[dat3$valid_name=="Mullidae"]<-"Mullus"
dat3$estrank[dat3$valid_name=="Mullidae"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Mullidae"]<-126034
dat3$SpeciesQualityCode[dat3$estsciname=="Mullidae"]<-"Family_to_genus"
find<-dat3[is.na(dat3$estrank)]
summary(find$valid_name)
# safe to assume Argentinidae=Argentina
find<-dat3[dat3$family=="Argentinidae"]
summary(find$valid_name[find$Country=="SPA"])
# Glossanodon leioglossus only found in Gulf of Cadiz - all ID to spp level
# safe to assume Argentinidae=Argentina
# change all Argentinidae to Argentina
dat3$estsciname[dat3$valid_name=="Argentinidae"]<-"Argentina"
dat3$estrank[dat3$valid_name=="Argentinidae"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Argentina"]<-125885 
dat3$SpeciesQualityCode[dat3$valid_name=="Argentinidae"]<-"Family_to_genus"
# all raja need to be called Rajidae because of changes in the taxonomic id things
dat3$estsciname[dat3$valid_name=="Rajidae"]<-"Rajidae"
dat3$estrank[dat3$valid_name=="Rajidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Rajidae"]<-160845
dat3$SpeciesQualityCode[dat3$estsciname=="Rajidae"]<-"Needs_assessment"
dat3$estsciname[dat3$valid_name=="Raja"]<-"Rajidae"
dat3$estrank[dat3$valid_name=="Raja"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Rajidae"]<-160845
dat3$SpeciesQualityCode[dat3$valid_name=="Raja"]<-"Family_to_genus"
# Gobiesocidae 
dat3$estsciname[dat3$valid_name=="Gobiesocidae"]<-"Gobiesocidae"
dat3$estrank[dat3$valid_name=="Gobiesocidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Gobiesocidae"]<-125477
dat3$SpeciesQualityCode[dat3$estsciname=="Gobiesocidae"]<-"Needs_assessment"
# Liparis
dat3$estsciname[dat3$valid_name=="Liparis"]<-"Liparis"
dat3$estrank[dat3$valid_name=="Liparis"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Liparis"]<-126160
dat3$SpeciesQualityCode[dat3$estsciname=="Liparis"]<-"Needs_assessment"
# Labridae
dat3$estsciname[dat3$valid_name=="Labridae"]<-"Labridae"
dat3$estrank[dat3$valid_name=="Labridae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Labridae"]<-125541 
dat3$SpeciesQualityCode[dat3$estsciname=="Labridae"]<-"Needs_assessment"
# Squalidae is the same as Squalus
find<-subset(dat3, family=="Squalidae")
unique(find$valid_name)
dat3$estsciname[dat3$valid_name=="Squalidae"]<-"Squalidae"
dat3$estrank[dat3$valid_name=="Squalidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Squalidae"]<-105716 
dat3$SpeciesQualityCode[dat3$estsciname=="Squalidae"]<-"Needs_assessment"
# Bothidae will become Arnoglossus
find<-subset(dat3, family=="Bothidae")
dat3$estsciname[dat3$valid_name=="Bothidae"]<-"Arnoglossus"
dat3$estrank[dat3$valid_name=="Bothidae"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Arnoglossus"]<-126109
dat3$SpeciesQualityCode[dat3$valid_name=="Bothidae"]<-"Family_to_genus"
dat3$estsciname[dat3$valid_name=="Arnoglossus"]<-"Arnoglossus"
dat3$estrank[dat3$valid_name=="Arnoglossus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Arnoglossus"]<-126109
dat3$SpeciesQualityCode[dat3$valid_name=="Arnoglossus"]<-"Needs_assessment"
# Callionymidae will become Callionymus
dat3$estsciname[dat3$valid_name=="Callionymidae"]<-"Callionymus"
dat3$estrank[dat3$valid_name=="Callionymidae"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Callionymus"]<-125930 
dat3$SpeciesQualityCode[dat3$valid_name=="Callionymidae"]<-"Family_to_genus"
dat3$estsciname[dat3$valid_name=="Callionymus"]<-"Callionymus"
dat3$estrank[dat3$valid_name=="Callionymus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Callionymus"]<-125930 
dat3$SpeciesQualityCode[dat3$valid_name=="Callionymus"]<-"Needs_assessment"
# Alosa           
dat3$estsciname[dat3$valid_name=="Alosa"]<-"Alosa"
dat3$estrank[dat3$valid_name=="Alosa"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Alosa"]<-125715 
dat3$SpeciesQualityCode[dat3$estsciname=="Alosa"]<-"Needs_assessment"
# Salmo           
dat3$estsciname[dat3$valid_name=="Salmo"]<-"Salmo"
dat3$estrank[dat3$valid_name=="Salmo"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Salmo"]<-126141 
dat3$SpeciesQualityCode[dat3$estsciname=="Salmo"]<-"Needs_assessment"
# Petromyzontidae 
dat3$estsciname[dat3$valid_name=="Petromyzontidae"]<-"Petromyzontidae"
dat3$estrank[dat3$valid_name=="Petromyzontidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Petromyzontidae"]<-101163 
dat3$SpeciesQualityCode[dat3$estsciname=="Petromyzontidae"]<-"Needs_assessment"
# Argentina       
dat3$estsciname[dat3$valid_name=="Argentina"]<-"Argentina"
dat3$estrank[dat3$valid_name=="Argentina"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Argentina"]<-125885
dat3$SpeciesQualityCode[dat3$estsciname=="Argentina"]<-"Needs_assessment"
# Gadiculus       
dat3$estsciname[dat3$valid_name=="Gadiculus"]<-"Gadiculus"
dat3$estrank[dat3$valid_name=="Gadiculus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Gadiculus"]<-125731
dat3$SpeciesQualityCode[dat3$estsciname=="Gadiculus"]<-"Needs_assessment"
# Chelidonichthys 
dat3$estsciname[dat3$valid_name=="Chelidonichthys"]<-"Chelidonichthys"
dat3$estrank[dat3$valid_name=="Chelidonichthys"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Chelidonichthys"]<-126178 
dat3$SpeciesQualityCode[dat3$estsciname=="Chelidonichthys"]<-"Needs_assessment"
# Zeugopterus    
dat3$estsciname[dat3$valid_name=="Zeugopterus"]<-"Zeugopterus"
dat3$estrank[dat3$valid_name=="Zeugopterus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Zeugopterus"]<-126125 
dat3$SpeciesQualityCode[dat3$valid_name=="Zeugopterus"]<-"Needs_assessment"
#Symphodus       
dat3$estsciname[dat3$valid_name=="Symphodus"]<-"Symphodus"
dat3$estrank[dat3$valid_name=="Symphodus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Symphodus"]<-126023 
dat3$SpeciesQualityCode[dat3$estsciname=="Symphodus"]<-"Needs_assessment"
# Syngnathidae   
dat3$estsciname[dat3$valid_name=="Syngnathidae"]<-"Syngnathidae"
dat3$estrank[dat3$valid_name=="Syngnathidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Syngnathidae"]<-125606
dat3$SpeciesQualityCode[dat3$estsciname=="Syngnathidae"]<-"Needs_assessment"
# Mugilidae      
dat3$estsciname[dat3$valid_name=="Mugilidae"]<-"Mugilidae"
dat3$estrank[dat3$valid_name=="Mugilidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Mugilidae"]<-125546 
dat3$SpeciesQualityCode[dat3$estsciname=="Mugilidae"]<-"Needs_assessment"
# Dicentrarchus  
dat3$estsciname[dat3$valid_name=="Dicentrarchus"]<-"Dicentrarchus"
dat3$estrank[dat3$valid_name=="Dicentrarchus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Dicentrarchus"]<-126029 
dat3$SpeciesQualityCode[dat3$estsciname=="Dicentrarchus"]<-"Needs_assessment"
# Syngnathus      
dat3$estsciname[dat3$valid_name=="Syngnathus"]<-"Syngnathus"
dat3$estrank[dat3$valid_name=="Syngnathus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Syngnathus"]<-126227 
dat3$SpeciesQualityCode[dat3$estsciname=="Syngnathus"]<-"Needs_assessment"
# Mustelus      
dat3$estsciname[dat3$valid_name=="Mustelus"]<-"Mustelus"
dat3$estrank[dat3$valid_name=="Mustelus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Mustelus"]<-105732 
dat3$SpeciesQualityCode[dat3$estsciname=="Mustelus"]<-"Needs_assessment"
# Gaidropsarus    
dat3$estsciname[dat3$valid_name=="Gaidropsarus"]<-"Gaidropsarus"
dat3$estrank[dat3$valid_name=="Gaidropsarus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Gaidropsarus"]<-125743 
dat3$SpeciesQualityCode[dat3$estsciname=="Gaidropsarus"]<-"Needs_assessment"
# Mullus         
dat3$estsciname[dat3$valid_name=="Mullus"]<-"Mullus"
dat3$estrank[dat3$valid_name=="Mullus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Mullus"]<-126034 
dat3$SpeciesQualityCode[dat3$estsciname=="Mullus"]<-"Needs_assessment"
# Pagellus       
dat3$estsciname[dat3$valid_name=="Pagellus"]<-"Pagellus"
dat3$estrank[dat3$valid_name=="Pagellus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Pagellus"]<-126079 
dat3$SpeciesQualityCode[dat3$estsciname=="Pagellus"]<-"Needs_assessment"
# Myctophidae     
dat3$estsciname[dat3$valid_name=="Myctophidae"]<-"Myctophidae"
dat3$estrank[dat3$valid_name=="Myctophidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Myctophidae"]<-125498 
dat3$SpeciesQualityCode[dat3$estsciname=="Myctophidae"]<-"Needs_assessment"
# Diaphus         
dat3$estsciname[dat3$valid_name=="Diaphus"]<-"Diaphus"
dat3$estrank[dat3$valid_name=="Diaphus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Diaphus"]<-125819 
dat3$SpeciesQualityCode[dat3$estsciname=="Diaphus"]<-"Needs_assessment"
# Argyropelecus   
dat3$estsciname[dat3$valid_name=="Argyropelecus"]<-"Argyropelecus"
dat3$estrank[dat3$valid_name=="Argyropelecus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Argyropelecus"]<-126196 
dat3$SpeciesQualityCode[dat3$estsciname=="Argyropelecus"]<-"Needs_assessment"
# Microchirus     
dat3$estsciname[dat3$valid_name=="Microchirus"]<-"Microchirus"
dat3$estrank[dat3$valid_name=="Microchirus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Microchirus"]<-126129 
dat3$SpeciesQualityCode[dat3$estsciname=="Microchirus"]<-"Needs_assessment"
#Zoarcidae       
dat3$estsciname[dat3$valid_name=="Zoarcidae"]<-"Zoarcidae"
dat3$estrank[dat3$valid_name=="Zoarcidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Zoarcidae"]<-125575 
dat3$SpeciesQualityCode[dat3$estsciname=="Zoarcidae"]<-"Needs_assessment"
# Lampanyctus    
dat3$estsciname[dat3$valid_name=="Lampanyctus"]<-"Lampanyctus"
dat3$estrank[dat3$valid_name=="Lampanyctus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Lampanyctus"]<-125825 
dat3$SpeciesQualityCode[dat3$estsciname=="Lampanyctus"]<-"Needs_assessment"
# change all Lampanyctus to Lampanyctus crocodilus
dat3$SpeciesQualityCode[dat3$estsciname=="Lampanyctus"]<-"Genus_to_spp"
dat3$estsciname[dat3$estsciname=="Lampanyctus"]<-"Lampanyctus crocodilus"
dat3$estrank[dat3$estsciname=="Lampanyctus crocodilus"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Lampanyctus crocodilus"]<-126612 
# Triglidae     
dat3$estsciname[dat3$valid_name=="Triglidae"]<-"Triglidae"
dat3$estrank[dat3$valid_name=="Triglidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Triglidae"]<-125598 
dat3$SpeciesQualityCode[dat3$estsciname=="Triglidae"]<-"Needs_assessment"
# Gasterosteidae  
dat3$estsciname[dat3$valid_name=="Gasterosteidae"]<-"Gasterosteidae"
dat3$estrank[dat3$valid_name=="Gasterosteidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Gasterosteidae"]<-125476 
dat3$SpeciesQualityCode[dat3$estsciname=="Gasterosteidae"]<-"Needs_assessment"
#Sebastes      
dat3$estsciname[dat3$valid_name=="Sebastes"]<-"Sebastes"
dat3$estrank[dat3$valid_name=="Sebastes"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Sebastes"]<-126175 
dat3$SpeciesQualityCode[dat3$estsciname=="Sebastes"]<-"Needs_assessment"
# Soleidae      
dat3$estsciname[dat3$valid_name=="Soleidae"]<-"Soleidae"
dat3$estrank[dat3$valid_name=="Soleidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Soleidae"]<-125581 
dat3$SpeciesQualityCode[dat3$estsciname=="Soleidae"]<-"Needs_assessment"
# Scyliorhinus    
dat3$estsciname[dat3$valid_name=="Scyliorhinus"]<-"Scyliorhinus"
dat3$estrank[dat3$valid_name=="Scyliorhinus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Scyliorhinus"]<-105729
dat3$SpeciesQualityCode[dat3$estsciname=="Scyliorhinus"]<-"Needs_assessment"
#Dipturus    
dat3$estsciname[dat3$valid_name=="Dipturus"]<-"Dipturus"
dat3$estrank[dat3$valid_name=="Dipturus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Dipturus"]<-105762 
dat3$SpeciesQualityCode[dat3$estsciname=="Dipturus"]<-"Needs_assessment"
#Clupeidae   
dat3$estsciname[dat3$valid_name=="Clupeidae"]<-"Clupeidae"
dat3$estrank[dat3$valid_name=="Clupeidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Clupeidae"]<-125464 
dat3$SpeciesQualityCode[dat3$estsciname=="Clupeidae"]<-"Needs_assessment"
#Macrouridae        
dat3$estsciname[dat3$valid_name=="Macrouridae"]<-"Macrouridae"
dat3$estrank[dat3$valid_name=="Macrouridae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Macrouridae"]<-125471 
dat3$SpeciesQualityCode[dat3$estsciname=="Macrouridae"]<-"Needs_assessment"
# Lycodes         
dat3$estsciname[dat3$valid_name=="Lycodes"]<-"Lycodes"
dat3$estrank[dat3$valid_name=="Lycodes"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Lycodes"]<-126104 
dat3$SpeciesQualityCode[dat3$estsciname=="Lycodes"]<-"Needs_assessment"
# Lophiidae     
dat3$estsciname[dat3$valid_name=="Lophiidae"]<-"Lophiidae"
dat3$estrank[dat3$valid_name=="Lophiidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Lophiidae"]<-125493 
dat3$SpeciesQualityCode[dat3$estsciname=="Lophiidae"]<-"Needs_assessment"
# Zeidae        
dat3$estsciname[dat3$valid_name=="Zeidae"]<-"Zeidae"
dat3$estrank[dat3$valid_name=="Zeidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Zeidae"]<-125617 
dat3$SpeciesQualityCode[dat3$estsciname=="Zeidae"]<-"Needs_assessment"
# Blenniidae     
dat3$estsciname[dat3$valid_name=="Blenniidae"]<-"Blenniidae"
dat3$estrank[dat3$valid_name=="Blenniidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Blenniidae"]<-125519
dat3$SpeciesQualityCode[dat3$estsciname=="Blenniidae"]<-"Needs_assessment"
# Phycidae    
dat3$estsciname[dat3$valid_name=="Phycidae"]<-"Phycidae"
dat3$estrank[dat3$valid_name=="Phycidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Phycidae"]<-125475 
dat3$SpeciesQualityCode[dat3$estsciname=="Phycidae"]<-"Needs_assessment"
# Sparidae       
dat3$estsciname[dat3$valid_name=="Sparidae"]<-"Sparidae"
dat3$estrank[dat3$valid_name=="Sparidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Sparidae"]<-125564 
dat3$SpeciesQualityCode[dat3$estsciname=="Sparidae"]<-"Needs_assessment"
# Stichaeidae        
dat3$estsciname[dat3$valid_name=="Stichaeidae"]<-"Stichaeidae"
dat3$estrank[dat3$valid_name=="Stichaeidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Stichaeidae"]<-125566 
dat3$SpeciesQualityCode[dat3$estsciname=="Stichaeidae"]<-"Needs_assessment"
# Cottidae        
dat3$estsciname[dat3$valid_name=="Cottidae"]<-"Cottidae"
dat3$estrank[dat3$valid_name=="Cottidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Cottidae"]<-125589 
dat3$SpeciesQualityCode[dat3$estsciname=="Cottidae"]<-"Needs_assessment"
#Lepidotrigla    
dat3$estsciname[dat3$valid_name=="Lepidotrigla"]<-"Lepidotrigla"
dat3$estrank[dat3$valid_name=="Lepidotrigla"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Lepidotrigla"]<-126179
dat3$SpeciesQualityCode[dat3$estsciname=="Lepidotrigla"]<-"Needs_assessment"
# change all Lepidotrigla to Lepidotrigla dieuzeidei
find<-dat3[dat3$genus=="Lepidotrigla"]
dat3$SpeciesQualityCode[dat3$estsciname=="Lepidotrigla"]<-"Genus_to_spp"
dat3$estsciname[dat3$estsciname=="Lepidotrigla"]<-"Lepidotrigla dieuzeidei"
dat3$estrank[dat3$estsciname=="Lepidotrigla dieuzeidei"]<-"Species"
dat3$estAphia_Code[dat3$estsciname=="Lepidotrigla dieuzeidei"]<-127265 
# Scorpaena   
dat3$estsciname[dat3$valid_name=="Scorpaena"]<-"Scorpaena"
dat3$estrank[dat3$valid_name=="Scorpaena"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Scorpaena"]<-125477
dat3$SpeciesQualityCode[dat3$estsciname=="Scorpaena"]<-"Needs_assessment"
# Scorpaenidae   
dat3$estsciname[dat3$valid_name=="Scorpaenidae"]<-"Scorpaenidae"
dat3$estrank[dat3$valid_name=="Scorpaenidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Scorpaenidae"]<-125595 
dat3$SpeciesQualityCode[dat3$estsciname=="Scorpaenidae"]<-"Needs_assessment"
# Congridae
dat3$estsciname[dat3$valid_name=="Congridae"]<-"Congridae"
dat3$estrank[dat3$valid_name=="Congridae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Congridae"]<-dat3$ValidAphiaID[dat3$estsciname=="Congridae"]
dat3$SpeciesQualityCode[dat3$estsciname=="Congridae"]<-"Needs_assessment"
# Moridae
dat3$estsciname[dat3$valid_name=="Moridae"]<-"Moridae"
dat3$estrank[dat3$valid_name=="Moridae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Moridae"]<-dat3$ValidAphiaID[dat3$estsciname=="Moridae"]
dat3$SpeciesQualityCode[dat3$estsciname=="Moridae"]<-"Needs_assessment"
# Alepocephalidae
dat3$estsciname[dat3$valid_name=="Alepocephalidae"]<-"Alepocephalidae"
dat3$estrank[dat3$valid_name=="Alepocephalidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Alepocephalidae"]<-dat3$ValidAphiaID[dat3$estsciname=="Alepocephalidae"]
dat3$SpeciesQualityCode[dat3$estsciname=="Alepocephalidae"]<-"Needs_assessment"
# Centrolophidae
dat3$estsciname[dat3$valid_name=="Centrolophidae"]<-"Centrolophidae"
dat3$estrank[dat3$valid_name=="Centrolophidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Centrolophidae"]<-dat3$ValidAphiaID[dat3$estsciname=="Centrolophidae"]
dat3$SpeciesQualityCode[dat3$estsciname=="Centrolophidae"]<-"Needs_assessment"
# Lophius
dat3$estsciname[dat3$valid_name=="Lophius"]<-"Lophius"
dat3$estrank[dat3$valid_name=="Lophius"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Lophius"]<-dat3$ValidAphiaID[dat3$estsciname=="Lophius"]
dat3$SpeciesQualityCode[dat3$estsciname=="Lophius"]<-"Needs_assessment"
#Notoscopelus
dat3$estsciname[dat3$valid_name=="Notoscopelus"]<-"Notoscopelus"
dat3$estrank[dat3$valid_name=="Notoscopelus"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Notoscopelus"]<-dat3$ValidAphiaID[dat3$estsciname=="Notoscopelus"]
dat3$SpeciesQualityCode[dat3$estsciname=="Notoscopelus"]<-"Needs_assessment"
# Cyclothone
dat3$estsciname[dat3$valid_name=="Cyclothone"]<-"Cyclothone"
dat3$estrank[dat3$valid_name=="Cyclothone"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Cyclothone"]<-dat3$ValidAphiaID[dat3$estsciname=="Cyclothone"]
dat3$SpeciesQualityCode[dat3$estsciname=="Cyclothone"]<-"Needs_assessment"
# Abramis     
dat3$estsciname[dat3$valid_name=="Abramis"]<-"Abramis"
dat3$estrank[dat3$valid_name=="Abramis"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Abramis"]<-dat3$ValidAphiaID[dat3$estsciname=="Abramis"]
dat3$SpeciesQualityCode[dat3$estsciname=="Abramis"]<-"Needs_assessment"
# Lobianchia      
dat3$estsciname[dat3$valid_name=="Lobianchia"]<-"Lobianchia"
dat3$estrank[dat3$valid_name=="Lobianchia"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Lobianchia"]<-dat3$ValidAphiaID[dat3$estsciname=="Lobianchia"]
dat3$SpeciesQualityCode[dat3$estsciname=="Lobianchia"]<-"Needs_assessment"
# Liparidae   
dat3$estsciname[dat3$valid_name=="Liparidae"]<-"Liparidae"
dat3$estrank[dat3$valid_name=="Liparidae"]<-"Family"
dat3$estAphia_Code[dat3$estsciname=="Liparidae"]<-dat3$ValidAphiaID[dat3$estsciname=="Liparidae"]
dat3$SpeciesQualityCode[dat3$estsciname=="Liparidae"]<-"Needs_assessment"

summary(as.factor(dat3$estrank))
summary(as.factor(dat3$SpeciesQualityCode))
############################
# 4.2.3 Geographical Range #
############################
# Is the species in the apporperate geographica range
# all alosa agone reported by sweden are suspect should be alosa alosa 
find<-dat3[dat3$valid_name=="Alosa agone"]
plot(find$ShootLong, find$ShootLat)
points(find$ShootLong[find$Country=="SWE"], find$ShootLat[find$Country=="SWE"], 
       col="blue", pch=19, add=T)
dat3$estsciname[dat3$valid_name=="Alosa agone"&dat3$Country=="SWE"]<-"Alosa alosa"
dat3$estrank[dat3$valid_name=="Alosa agone"&dat3$Country=="SWE"]<-"Species"
dat3$estAphia_Code[dat3$valid_name=="Alosa agone"&dat3$Country=="SWE"]<-126413 
dat3$SpeciesQualityCode[dat3$valid_name=="Alosa agone"&dat3$Country=="SWE"]<-"Species_changed"
# Abramis - flagged as freshwater genus
find<-dat3[dat3$genus=="Abramis"]
# only one record ever found in any survey its a fresh/brackish species!
# remove record
nrow(dat3)
dat3<-subset(dat3, !genus=="Abramis", )
nrow(dat3)
# Flagged as Questionable Distribution 127228	Paraliparis membranaceus
find<-subset(dat3, valid_name=="Paraliparis membranaceus", )
# 37 records
# retain as its okay - WoRMS suggests it is found in EU waters
# Flagged as Questionable Distribution 126503	Urophycis chuss 
# it has got an Atlantic distribution so leave it as is
find<-subset(dat3, valid_name=="Urophycis chuss", )
# 4 records
# Flagged as Questionable Distribution Bathyraja brachyurops
find<-subset(dat3, valid_name=="Bathyraja brachyurops", )
# changed by DP
# Flagged as Questionable Distribution Scomber japonicus
find<-subset(dat3, valid_name=="Scomber japonicus", )
# changed by DP
# Flagged as Questionable Distribution Anarrhichthys ocellatus
find<-subset(dat3, valid_name=="Anarrhichthys ocellatus", )
# changed by DP
# Flagged as Questionable Distribution Hippocampus histrix
find<-subset(dat3, valid_name=="Hippocampus histrix", )
# # changed by DP
# Flagged as Questionable Distribution Leucoraja lentiginosa
find<-subset(dat3, valid_name=="Leucoraja lentiginosa", )
# 1 record -change to Unkown ray and reassign using k-NN procedure 
# Flagged as Questionable Distribution Lycodes vahlii
dat3$estsciname[dat3$valid_name=="Leucoraja lentiginosa"]<-"Leucoraja"
dat3$estrank[dat3$valid_name=="Leucoraja"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Leucoraja"]<-105763
dat3$SpeciesQualityCode[dat3$valid_name=="Leucoraja lentiginosa"]<-"Spp_to_genus"

find<-subset(dat3, valid_name=="Lycodes vahlii", )
# 3853 records 
# outside of native range but habitat is suitable - no reason to change but 
# could be Lycodes gracilis
# Flagged as Questionable Distribution Benthodesmus elongatus
find<-subset(dat3, valid_name=="Benthodesmus elongatus", )
# this has got an Atlantic distribution - retain as is
# Flagged as Questionable Distribution Nezumia bairdii
find<-subset(dat3, valid_name=="Nezumia bairdii", )
# one record -  shouldn't be reporded in this region 
# put to genus level and reassign using  k-NN
dat3$estsciname[dat3$valid_name=="Nezumia bairdii"]<-"Nezumia"
dat3$estrank[dat3$valid_name=="Nezumia"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Nezumia"]<-125754
dat3$SpeciesQualityCode[dat3$valid_name=="Nezumia bairdii"]<-"Spp_to_genus"
# Flagged as Questionable Distribution Spratelloides lewisi
find<-subset(dat3, valid_name=="Spratelloides lewisi", )
# 20 records of a Western Central Pacific species -
# # put to genus level and reassign using  k-NN
dat3$estsciname[dat3$valid_name=="Spratelloides lewisi"]<-"Spratelloides"
dat3$estrank[dat3$valid_name=="Spratelloides lewisi"]<-"Genus"
dat3$estAphia_Code[dat3$estsciname=="Spratelloides"]<-125722
dat3$SpeciesQualityCode[dat3$valid_name=="Spratelloides lewisi"]<-"Spp_to_genus"
find<-dat3[is.na(dat3$estrank)]
summary(dat3$estsciname)
# save a copy of hauls and biology
write.csv(dat3, "dat3_11-11-2016.csv")
write.csv(hauls1, "hauls1_11-11-2016.csv")
dat4<-read.csv("dat3_11-11-2016.csv", header=TRUE, stringsAsFactors = FALSE)
dat4$estsciname[dat4$valid_name=="Leucoraja lentiginosa"]<-"Leucoraja"
dat4$estsciname[dat4$valid_name=="Spratelloides lewisi"]<-"Spratelloides"
dat4$estsciname[dat4$valid_name=="Nezumia bairdii"]<-"Nezumia"
##################################
# 4.2.4 Length Codes Corrections #
##################################
# 4.2.4.1 Standardise DATRAS Codes
# DATRAS allows multiple formats for length
# There are codes that allow us to distingush the type of data recorded
# All data will be brought to a single code for each type of data
dat4<-as.data.table(dat4)
# Further to this some species are 
# lets get all the length codes to the same currency - 1cm class
summary(as.numeric(dat4$LngtClass))
summary(as.factor(dat4$LngtCode))
dat4$LngtClass<-as.numeric(dat3$LngtClass)
dat4[LngtCode=="."|LngtCode=="0",
    c("newLngtCode", "newLngtClass") :=
      list("cm", LngtClass/10)]
dat4[LngtCode=="1",
    c("newLngtCode", "newLngtClass") :=
      list("cm", LngtClass)]
dat4[LngtCode=="5",
    c("newLngtCode", "newLngtClass") :=
      list("cm", (LngtClass+(LngtClass+4))/2)]
summary(dat4$newLngtClass)
dat4$newLngtClass[is.na(dat4$LngtClass)]<-0
#####################################
# 4.2.5 Abundance Codes Corrections #
#####################################
# Deal with C data - this needs to be brought back to R
# when DataType = C  HLNoAtLngt/60 * HaulDur
# when DataType = C  TotalNo/60 * HaulDur 
# Adds 3 new Cols
# NewDataType= R ,  NewTotalNo ,  NewHLNoAtLngt
summary(as.factor(dat4$DataType))
dat4$NewDataType[dat4$DataType=="R"]<-"R"
dat4$NewDataType[dat4$DataType=="C"]<-"R"
dat4$NewDataType[dat4$DataType=="S"]<-"RS"
summary(as.factor(dat4$NewDataType))
dat4$TotalNo_N<-as.numeric(dat4$TotalNo)
dat4$HaulDur<-as.numeric(dat4$HaulDur)
summary(as.numeric(dat4$TotalNo))
summary(find$SubFactor)
summary(as.factor(find$SubFactor))
# check these are all whole numbers 
#so 1 is not equal to Inf i'll just remove that also the HL Noat Lenght is 1 
# the subfactor is inf - that should be 1
dat4$TotalNo[dat4$New_UniqueID=="NIGFS/2004/4/LF/62/ROT"
            &dat4$valid_name=="Gobiidae"]<-1
dat4$SubFactor[dat4$New_UniqueID=="NIGFS/2004/4/LF/62/ROT"
              &dat4$valid_name=="Gobiidae"]<-1
dat4$HLNoAtLngt_N<-as.numeric(dat4$HLNoAtLngt)
summary(dat4$HLNoAtLngt_N)
# check
find<- subset(dat4,dat4$HLNoAtLngt_N>dat4$TotalNo )
summary(find$HLNoAtLngt_N)
summary(find$TotalNo)
# strange things going on with some of the HLNoatLng- really big numbers should be -9/NA
dat4$NoMeas[dat4$NoMeas=="-9"]<-NA
dat4$NoMeas[dat4$NoMeas=="0"]<-NA
dat4$HLNoAtLngt[dat4$TotalNo=="-9"]<-"-9"
dat4$HLNoAtLngt[dat4$TotalNo=="0"]<-"0"
dat4$HLNoAtLngt[dat4$HLNoAtLngt=="-9"]<-"0"
dat4$TotalNo[dat4$TotalNo=="-9"]<-"0"
dat4$TotalNo[is.na(dat4$TotalNo)]<-"0"
dat4$HLNoAtLngt[is.na(dat4$HLNoAtLngt)]<-"0"
summary(as.numeric(dat4$HLNoAtLngt))
summary(as.numeric(dat4$TotalNo))
#dat4$HLNoAtLngt<-as.numeric(dat4$HLNoAtLngt)
summary(as.numeric(dat4$TotalNo))
summary(as.numeric(dat4$HLNoAtLngt))

dat4$TotalNo_N<-as.numeric(dat4$TotalNo)
summary(dat4$HLNoAtLngt_N)
dat4$HLNoAtLngt_N[(dat4$HLNoAtLngt_N<0)]<-0
dat4$NewTotalNo[dat4$DataType=="R"]<-dat4$TotalNo_N[dat4$DataType=="R"]
dat4$NewTotalNo[dat4$DataType=="S"]<-dat4$TotalNo_N[dat4$DataType=="S"]
dat4$NewTotalNo[dat4$DataType=="C"]<-(dat4$TotalNo_N[dat4$DataType=="C"])/60*dat4$HaulDur[dat4$DataType=="C"]
dat4$NewHLNoAtLngt[dat4$DataType=="R"]<-dat4$HLNoAtLngt_N[dat4$DataType=="R"]
dat4$SubFactor<-as.numeric(dat4$SubFactor)
summary(dat4$SubFactor)

dat4$NewHLNoAtLngt[dat4$DataType=="S"]<-dat4$HLNoAtLngt_N[dat4$DataType=="S"]*dat4$SubFactor[dat4$DataType=="S"]
dat4$NewHLNoAtLngt[dat4$DataType=="R"]<-dat4$HLNoAtLngt_N[dat4$DataType=="R"]*dat4$SubFactor[dat4$DataType=="R"]
dat4$NewHLNoAtLngt[dat4$DataType=="C"]<-(dat4$HLNoAtLngt_N[dat4$DataType=="C"])/60*dat4$HaulDur[dat4$DataType=="C"]
summary(as.numeric(dat4$NewTotalNo))
dat4$NewHLNoAtLngt[is.na(dat4$HLNoAtLngt_N)]<-0
summary(as.numeric(dat4$NewHLNoAtLngt))
summary(dat4$NewTotalNo)
#dat4$NoMeas<-as.numeric(dat4$NoMeas)
summary(dat4$NoMeas)
# Lets take a closer look at S cat.
names(dat4)
summary(as.numeric(dat4$SubFactor[dat4$NewDataType=="RS"]))
summary(as.numeric(dat4$NewHLNoAtLngt))
# if subfactor is 1` then S should really be R!
dat4$NewDataType[dat4$DataType=="S"]<-"RS"
dat4$NewDataType[dat4$DataType=="S"&dat4$SubFactor==1]<-"R"
summary(as.factor(dat4$NewDataType))

summary((dat4$NewTotalNo))
dat4$NewTotalNo[is.na(dat4$NewTotalNo)]<-0
# 6524 say they have a subfactor but in reality there are more Subfactors 
# in R
dat4$HaulDur<-as.numeric(dat4$HaulDur)
dat4$SubFactor<-as.numeric(dat4$SubFactor)
subfactor_size<-subset(dat4, NewDataType=="RS", )
summary(subfactor_size$SubFactor)
subfactor_size$Actual_Haul_Duration<-(subfactor_size$HaulDur/subfactor_size$SubFactor)  
summary(subfactor_size$Actual_Haul_Duration)
length((subfactor_size$Actual_Haul_Duration[subfactor_size$Actual_Haul_Duration>12]))
summary(subfactor_size$HaulDur)

# So the Total number is already Raised no need to multiply the Subfactor 
# but the HL_no_at_lenght isnt raised.
# based on the fact that some of the haul times of the subsampled 
# haul is only a fraction of the actual haul time, we must consider that some of 
# these hauls may be missing out on the min haul criteria and should be removed
smallhauls<- subset(h, HaulDur<12 , )
summary(dat4$HaulDur)

dat4$SubFactor[is.na(dat4$SubFactor)]<-1
summary(dat4$SubFactor)
dat4$Est_HaulDur<-dat4$HaulDur  
dat4$Est_HaulDur[dat4$NewDataType=="RS"]<-(dat4$HaulDur[dat4$NewDataType=="RS"]/dat4$SubFactor[dat4$NewDataType=="RS"])

summary(dat4$Est_HaulDur)
# Add a flag to the Subsampled hauls that may be too short
dat4$Est_HaulDur_flag[dat4$Est_HaulDur>12]<-"no_issue"
dat4$Est_HaulDur_flag[dat4$Est_HaulDur<13]<-"subsample_too_small_for_biodiversity_sample"
summary(as.factor(dat4$Est_HaulDur_flag))
summary(as.factor(dat4$SpecVal))
dat4$New_Spec_Val[dat4$SpecVal=="1"]<-1
dat4$New_Spec_Val[dat4$SpecVal=="V"]<-1
Sub_SampledHauls<-subset(dat4, dat4$Est_HaulDur_flag=="subsample_too_small_for_biodiversity_sample",)
list<-Sub_SampledHauls$New_UniqueID
summary(as.factor(Sub_SampledHauls$Survey))
unique(Sub_SampledHauls$New_UniqueID)
list1<-unique(list)
summary(as.factor(dat4$Est_HaulDur_flag))
4332/5485118*100
# effects  0.07897733% of samples 
268/48487*100
# in 0.5527255% of hauls
# now use the new numbers at lenght to get densities
#dat4$HLNoAtLngt<-as.numeric(dat4$HLNoAtLngt)
dat4$NewHLNoAtLngt_round<-round(dat4$NewHLNoAtLngt)
dat4$NewTotalNo_roundup<-ceiling(dat4$NewTotalNo)
#dat4$SweptArea_wing_km_sqrd<-as.numeric(dat4$SweptArea_wing_km_sqrd)
dat4[!is.na(NewHLNoAtLngt), c("HLNoAtLngtkm2") :=
      list(NewHLNoAtLngt/SweptArea_wing_km_sqrd)] 
dat4[!is.na(NewTotalNo), c("TotalNoKm2"):=
      list(NewTotalNo/SweptArea_wing_km_sqrd)]
summary(dat4$TotalNoKm2)
summary(dat4$HLNoAtLngtkm2)
#dat4[!is.na(HLNoAtLngtkm2), c("HLNoATLngt_Derived"):=
#      list(HLNoAtLngtkm2*SweptArea_wing_km_sqrd)]
#dat4[!is.na(TotalNoKm2), c("TotalNoKm2_Derived"):=
#      list(TotalNoKm2*SweptArea_wing_km_sqrd)]
#find<-subset(dat4, dat4$NewHLNoAtLngt_round> dat4$NewTotalNo_roundup,)
dat4$NewHLNoAtLngt_round<-NULL
dat4$NewTotalNo_roundup<-NULL
#Still some differences between total number and highter no at length measured
# what a total mess

dat4$Density_Km2<-dat4$HLNoAtLngtkm2
dat4$Density_Km2[dat4$HLNoAtLngtkm2==0]<-dat4$TotalNoKm2[dat4$HLNoAtLngtkm2==0]
summary(dat4$Density_Km2)
find<-subset(dat4, Density_Km2==0, )
# I will address theses 62 fish later on in code
#######################
# Insure Length is TL #
#######################
dat4$FishLength_cm<-dat4$newLngtClass
# Not all fish are measured to TL some are measured to SL, PAFL and PSCFL 
# These need converting to TL
# Fish measured to SL, PAFL and PSCFL instead of TL
dat4$LengthType[dat4$family=="Macrouridae"]<-"PAFL"
dat4$LengthType[dat4$family=="Alepocephalidae"]<-"SL"
dat4$LengthType[dat4$family=="Chimaeridae"]<-"PSCFL"
dat4$LengthType[is.na(dat4$LengthType)]<-"TL"
# EVHOE - not measuring to PAFL
# fish measured to SL, PAFL and PSCFL instead of TL
dat4$LengthType[dat4$family=="Macrouridae"&dat4$Survey=="EVHOE"]<-"TL"
# SWC and NS-IBTS didn't inplement PAFL measurements until 1999
dat4$LengthType[dat4$family=="Macrouridae"&dat4$Survey=="SWC-IBTS"&dat4$Year<1999]<-"TL"
dat4$LengthType[dat4$family=="Macrouridae"&dat4$Survey=="NS-IBTS"&dat4$Year<1999]<-"TL"
dat4$LengthType[dat4$family=="Macrouridae"&dat4$Survey=="SP_ARSA"&dat4$Year<2000]<-"TL"
dat4$LengthType[dat4$family=="Macrouridae"&dat4$Survey=="SP_PORC"&dat4$Year<2000]<-"TL"
dat4$LengthType[dat4$family=="Macrouridae"&dat4$Survey=="SPNGFSC"&dat4$Year<2000]<-"TL"
# Hymenocephalus italicus is TL Mindel et al 2015
dat4$LengthType[dat4$estsciname=="Hymenocephalus italicus"&
                  dat4$LengthType=="PAFL"]<-"TL"
dat4$LengthType[dat4$estsciname=="Hymenocephalus gracilis"&
                  dat4$LengthType=="PAFL"]<-"TL"
# in SP-ARSA before 2003 Nezumia aequalis was measured at TL
unique(dat4$Survey)
dat4$LengthType[dat4$estsciname=="Nezumia aequalis"&
                  dat4$Survey=="SP_ARSA"&dat4$Year<2003]<-"TL"
dat4$LengthType[dat4$estsciname=="Nezumia aequalis"&
                  dat4$Survey=="SP_ARSA"&dat4$Year==2004&dat4$newLngtClass>10]<-"TL"
# in SP-PORC before 2001 Nezumia aequalis was measured at TL
dat4$LengthType[dat4$estsciname=="Nezumia aequalis"&
                  dat4$Survey=="SP_PORC"&dat4$Year<2001]<-"TL"
# in SP-PORC up to 2004 Coelorinchus caelorhincus was measured at TL
dat4$LengthType[dat4$estsciname=="Coelorinchus caelorhincus"&
                  dat4$Survey=="SP_PORC"&dat4$Year<2005]<-"TL"
# Coelorinchus caelorhincus
dat4$LengthType[dat4$estsciname=="Coelorinchus caelorhincus"&
                  dat4$Survey=="SPNGFS"&dat4$Year<2010]<-"TL"
# Coelorinchus caelorhincus
dat4$LengthType[dat4$estsciname=="Coelorinchus caelorhincus"&
                  dat4$Survey=="IE-IGFS"&dat4$Year<2008 & dat4$newLngtClass>10]<-"TL"
# in SPNGFS up to 2009 Malacocephalus laevis was measured at TL
dat4$LengthType[dat4$estsciname=="Malacocephalus laevis"&
                  dat4$Survey=="SPNGFS"&dat4$Year<2010]<-"TL"
dat4$LengthType[dat4$estsciname=="Malacocephalus laevis"&
                  dat4$Survey=="SP_ARSA"&dat4$Year<2003]<-"TL"
dat4$LengthType[dat4$estsciname=="Malacocephalus laevis"&
                  dat4$Survey=="SP_ARSA"&dat4$Year==2004&dat4$newLngtClass>20]<-"TL"
dat4$LengthType[dat4$estsciname=="Malacocephalus laevis"&
                  dat4$Survey=="IE-IGFS"&dat4$Year<2007]<-"TL"
dat4$LengthType[dat4$estsciname=="Malacocephalus laevis"&
                  dat4$Survey=="NS-IBTS"&dat4$Year==2016]<-"TL"
dat4$LengthType[dat4$estsciname=="Coelorinchus caelorhincus"&
                  dat4$Survey=="SP_PORC"&dat4$Year<2005]<-"TL"
dat4$LengthType[dat4$estsciname=="Trachyrincus scabrus"&
                  dat4$Survey=="IE-IGFS"&dat4$Year<2007]<-"TL"
dat4$LengthType[dat4$estsciname=="Trachyrincus scabrus"&
                  dat4$Survey=="SP_PORC"]<-"TL"
# Macrouridae Mindel et al 2015
dat4$LengthType[dat4$estsciname=="Macrouridae"&dat4$LengthType=="PAFL"]<-"TL"
############### PAFL to TL ###############
# Total Length converter for COC (Coelorinchus caelorhincus) is *2.82
# Total Length converter for MLA (Malacocephalus laevis) is *4.57
summary(as.factor(dat4$LengthType))
# need to address the PAFL and PSCFL and use an approperiate conversion factor.
# fisrt check length information as it stands
PAFL_fish<-subset(dat4, LengthType=="PAFL",)
write.csv(PAFL_fish, "PAFL_fish_07-10-2016.csv")
# The palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#FFFF00")

ggplot(PAFL_fish, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme_classic()

ggplot(PAFL_fish, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~valid_name, scales="free", ncol=4)+
  theme_classic()
# look closer at Trachyrincus scabrus
find<-subset(PAFL_fish, estsciname=="Trachyrincus scabrus",)
ggplot(find, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
# Trachyrincus murrayi Mindel et al 2015
dat4$FishLength_cm[dat4$estsciname=="Trachyrincus scabrus"&
                   dat4$LengthType=="PAFL"]<-3.1*dat4$newLngtClass[dat4$estsciname=="Trachyrincus scabrus"&
                                                 dat4$LengthType=="PAFL"]
dat4$LengthType[dat4$estsciname=="Trachyrincus scabrus"&
                  dat4$LengthType=="PAFL"]<-"TL"
# Trachyrincus murrayi Mindel et al 2015
#dat4$FishLength_cm[dat4$estsciname=="Trachyrincus murrayi"&
#                     dat4$LengthType=="PAFL"]<-3.1*dat4$newLngtClass[dat4$estsciname=="Trachyrincus murrayi"&
#                                                                       dat4$LengthType=="PAFL"]
dat4$LengthType[dat4$estsciname=="Trachyrincus murrayi"&
                  dat4$LengthType=="PAFL"]<-"TL"
# look closer at Nezumia aequalis
find<-subset(PAFL_fish, estsciname=="Nezumia aequalis",)
ggplot(find, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
# Nezumia aequalis Mindel et al 2015

dat4$FishLength_cm[dat4$estsciname=="Nezumia aequalis"&
                     dat4$LengthType=="PAFL"]<-3.78*dat4$newLngtClass[dat4$estsciname=="Nezumia aequalis"&
                                                                        dat4$LengthType=="PAFL"]
dat4$LengthType[dat4$estsciname=="Nezumia aequalis"&
                  dat4$LengthType=="PAFL"]<-"TL"
dat4$FishLength_cm[dat4$estsciname=="Nezumia sclerorhynchus"&
                     dat4$LengthType=="PAFL"]<-3.98*dat4$newLngtClass[dat4$estsciname=="Nezumia sclerorhynchus"&
                                                                        dat4$LengthType=="PAFL"]
dat4$LengthType[dat4$estsciname=="Nezumia sclerorhynchus"&
                  dat4$LengthType=="PAFL"]<-"TL"
#Nezumia sclerorhynchus
dat4$FishLength_cm[dat4$estsciname=="Nezumia"&
                     dat4$LengthType=="PAFL"]<-3.88*dat4$newLngtClass[dat4$estsciname=="Nezumia"&
                                                                        dat4$LengthType=="PAFL"]
dat4$LengthType[dat4$estsciname=="Nezumia"&
                  dat4$LengthType=="PAFL"]<-"TL"
# look closer at Coelorinchus caelorhincus
find<-subset(PAFL_fish, estsciname=="Coelorinchus caelorhincus",)
ggplot(find, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
dat4$FishLength_cm[dat4$estsciname=="Coelorinchus caelorhincus"&
                     dat4$LengthType=="PAFL"]<-dat4$newLngtClass[dat4$estsciname=="Coelorinchus caelorhincus"&
                                                                   dat4$LengthType=="PAFL"]*2.82
dat4$LengthType[dat4$estsciname=="Coelorinchus caelorhincus"&
                  dat4$LengthType=="PAFL"]<-"TL"
# look closer at Malacocephalus laevis
find<-subset(PAFL_fish, estsciname=="Malacocephalus laevis",)
ggplot(find, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
dat4$FishLength_cm[dat4$estsciname=="Malacocephalus laevis"&
                     dat4$LengthType=="PAFL"]<-dat4$newLngtClass[dat4$estsciname=="Malacocephalus laevis"&
                                                                   dat4$LengthType=="PAFL"]*4.57
dat4$LengthType[dat4$estsciname=="Malacocephalus laevis"&
                  dat4$LengthType=="PAFL"]<-"TL"

#Atkinson 1991
dat4$FishLength_cm[dat4$estsciname=="Macrourus berglax"&
                     dat4$LengthType=="PAFL"]<-5.2320+2.3455*dat4$newLngtClass[dat4$estsciname=="Macrourus berglax"&
                                                                                 dat4$LengthType=="PAFL"]
dat4$LengthType[dat4$estsciname=="Macrourus berglax"&
                  dat4$LengthType=="PAFL"]<-"TL"

# Atkinson 1981 -Coryphaenoides rupestris
find<-subset(PAFL_fish, estsciname=="Coryphaenoides rupestris",)
ggplot(find, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
dat4$FishLength_cm[dat4$estsciname=="Coryphaenoides rupestris"&
                     dat4$LengthType=="PAFL"]<-4.7399*dat4$newLngtClass[dat4$estsciname=="Coryphaenoides rupestris"&
                                                                          dat4$LengthType=="PAFL"]-1.6368
dat4$LengthType[dat4$estsciname=="Coryphaenoides rupestris"&
                  dat4$LengthType=="PAFL"]<-"TL"

#Coelorinchus labiatus Mindel et al 2015
dat4$FishLength_cm[dat4$estsciname=="Coelorinchus labiatus"&
                     dat4$LengthType=="PAFL"]<-2.5*dat4$newLngtClass[dat4$estsciname=="Coelorinchus labiatus"&
                                                                       dat4$LengthType=="PAFL"]
dat4$LengthType[dat4$estsciname=="Coelorinchus labiatus"&
                  dat4$LengthType=="PAFL"]<-"TL"

summary(as.factor(dat4$LengthType))
############ SL to TL############
SL_fish<-subset(dat4, LengthType=="SL",)
summary(as.factor(SL_fish$estsciname))
## Xenodermichthys copei
dat4$FishLength_cm[dat4$estsciname=="Xenodermichthys copei"&
                     dat4$LengthType=="SL"]<-1.155*dat4$newLngtClass[dat4$estsciname=="Xenodermichthys copei"&
                                                                               dat4$LengthType=="SL"]
dat4$LengthType[dat4$estsciname=="Xenodermichthys copei"&
                  dat4$LengthType=="SL"]<-"TL"

dat4$FishLength_cm[dat4$estsciname=="Alepocephalus rostratus"&
                     dat4$LengthType=="SL"]<-1.127*dat4$newLngtClass[dat4$estsciname=="Alepocephalus rostratus"&
                                                                       dat4$LengthType=="SL"]
dat4$LengthType[dat4$estsciname=="Alepocephalus rostratus"&
                  dat4$LengthType=="SL"]<-"TL"

dat4$FishLength_cm[dat4$estsciname=="Alepocephalus bairdii"&
                     dat4$LengthType=="SL"]<-1.089*dat4$newLngtClass[dat4$estsciname=="Alepocephalus bairdii"&
                                                                       dat4$LengthType=="SL"]
dat4$LengthType[dat4$estsciname=="Alepocephalus bairdii"&
                  dat4$LengthType=="SL"]<-"TL"
dat4$FishLength_cm[dat4$estsciname=="Alepocephalidae"&
                     dat4$LengthType=="SL"]<-1.123667*dat4$newLngtClass[dat4$estsciname=="Alepocephalidae"&
                                                                       dat4$LengthType=="SL"]
dat4$LengthType[dat4$estsciname=="Alepocephalidae"&
                  dat4$LengthType=="SL"]<-"TL"
############### PSCFL to TL###############
PSCFL_fish<-subset(dat4, LengthType=="PSCFL",)
write.csv(PSCFL_fish, "PSCFL_fish_07-10-2016.csv")
summary(as.factor(PSCFL_fish$estsciname))
ggplot(PSCFL_fish, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme_classic()

ggplot(PSCFL_fish, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ estsciname, scales="free", ncol=1)+
  theme_classic()
# EVHOE measures TL not PSCFL
dat4$LengthType[dat4$family=="Chimaeridae"&dat4$Survey=="EVHOE"]<-"TL"
dat4$FishLength_cm[dat4$family=="Chimaeridae"&
                     dat4$LengthType=="PSCFL"]<-dat4$newLngtClass[dat4$family=="Chimaeridae"&
                                                                            dat4$LengthType=="PSCFL"]*1.31
dat4$FishLength_cm[dat4$estsciname=="Hydrolagus mirabilis"&
                     dat4$LengthType=="PSCFL"]<-dat4$newLngtClass[dat4$estsciname=="Hydrolagus mirabilis"&
                                                                            dat4$LengthType=="PSCFL"]*1.28
dat4$LengthType[dat4$family=="Chimaeridae"&
                  dat4$LengthType=="PSCFL"]<-"TL"
summary(as.factor(dat4$LengthType))

find<-dat4[ which(dat4$FishLength_cm > dat4$newLngtClass),]
summary(as.factor(find$estsciname))
ggplot(find, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ estsciname, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
ggplot(find, aes(x=FishLength_cm, y=Density_Km2, color=Survey, cex=1))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ estsciname, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
ggplot(find, aes(x=newLngtClass, y=Density_Km2, color=Survey))+
  scale_colour_manual(values=cbbPalette)+
  geom_point()+
  facet_wrap(~ Year, scales="free", ncol=4)+
  theme(text = element_text(size=20),
        axis.text.x = element_text(vjust=1))
#######################
# Check LMax - step 1 #
#######################	
# List species records which exceed their maximum reported length
names(dat4)
# Read in fish Max data
#plot(dat4$LmaxFB*1.1, dat4$newLngtClass, pch=19, xlim=c(1,500)
#    , ylim=c(1,500), xlab="Species LMax + 10%",
#     ylab="Species Recorded Length",
#     col=cols[dat4$valid_name], main="Species Length Classes")
#abline(0, 1, col="red")
#plot(dat4$MaxLngt, dat4$newLngtClass, pch=19, xlim=c(1,75)
#     , ylim=c(1,75), xlab="Species LMax + 10%",
#     ylab="Species Recorded Length",
#     col=cols[dat4$scientificname], main="GOV Species Length Classes")
#abline(0, 1, col="red")
# write a piece of code to capture all records that exceed lmax
summary(dat4$FishLength_cm)
summary(dat4$LmaxFB)
test1 <- dat4[ which(dat4$FishLength_cm > dat4$LmaxFB*1.4),]
unique(test1$valid_name[test1$family=="Macrouridae"])
unique(test1$Year[test1$family=="Macrouridae"])
unique(test1$Country[test1$family=="Macrouridae"])
# some of the data providers have provided answers on the L max questions
# some are genuine mistakes with corrections available 
# fix using uniqueID, spp Valid Aphia and Lenght class - this could 
# take a while to code
#length change 1. Buglossidium luteum to Solea solea
names(dat4)
find<-subset(dat4,New_UniqueID=="NS-IBTS/1983/1/EXP/15/GOV", )
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1983/1/EXP/15/GOV"&
                         dat4$ValidAphiaID==127153&
                         dat4$newLngtClass==28]<-127160 
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1983/1/EXP/15/GOV"&
                  dat4$ValidAphiaID==127153&
                  dat4$newLngtClass==28]<-"Solea solea"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1983/1/EXP/15/GOV"&
                 dat4$ValidAphiaID==127153&dat4$newLngtClass==28]<-"Species_changed(DP)"
#length change 2.Buglossidium luteum to Microchirusvariegatus
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1984/1/EXP/17/GOV"&
                         dat4$ValidAphiaID==127153&
                         dat4$newLngtClass==22]<-274304  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1984/1/EXP/17/GOV"&
                  dat4$ValidAphiaID==127153&
                  dat4$newLngtClass==22]<-"Microchirus variegatus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1984/1/EXP/17/GOV"&
                 dat4$ValidAphiaID==127153&dat4$newLngtClass==22]<-"Species_changed(DP)"
#length change 3.Buglossidium luteum to Microchirusvariegatus
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1995/4/SCO2/20/GOV"&
                         dat4$ValidAphiaID==127153&
                         dat4$newLngtClass==22]<-274304  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1995/4/SCO2/20/GOV"&
                  dat4$ValidAphiaID==127153&
                  dat4$newLngtClass==22]<-"Microchirus variegatus"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1995/4/SCO2/20/GOV"&
                 dat4$ValidAphiaID==127153&dat4$newLngtClass==22]<-"Species_changed(DP)"
#length change 4.Buglossidium luteum to Microchirusvariegatus
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2000/1/SCO2/30/GOV"&
                         dat4$ValidAphiaID==127153&
                         dat4$newLngtClass==22]<-274304  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2000/1/SCO2/30/GOV"&
                  dat4$ValidAphiaID==127153&
                  dat4$newLngtClass==22]<-"Microchirus variegatus"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2000/1/SCO2/30/GOV"&
                 dat4$ValidAphiaID==127153&dat4$newLngtClass==22]<-"Species_changed(DP)"
#length change 5.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/43/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==24]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/43/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==24]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/43/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==24]<-"Species_changed(DP)"
#length change 6.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/43/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==30]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/43/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==30]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/43/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==30]<-"Species_changed(DP)"
#length change 7.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/65/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==23]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/65/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==23]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/65/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==23]<-"Species_changed(DP)"
#length change 8.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/66/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==25]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/66/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==25]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/66/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==25]<-"Species_changed(DP)"
#length change 9.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/66/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==27]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/66/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==27]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/66/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==27]<-"Species_changed(DP)"
#length change 10.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/10/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==23]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/10/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==23]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/10/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==23]<-"Species_changed(DP)"
#length change 11.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/38/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==24]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/38/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==24]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/38/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==24]<-"Species_changed(DP)"
#length change 12.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/43/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==27]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/43/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==27]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/43/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==27]<-"Species_changed(DP)"
#length change 13.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/53/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==25]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/53/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==25]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1992/1/SCO2/53/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==25]<-"Species_changed(DP)"
#length change 14.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1993/4/SCO2/10/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==25]<-126792  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1993/4/SCO2/10/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==25]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1993/4/SCO2/10/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==25]<-"Species_changed(DP)"
#length change 15.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1994/1/SCO2/39/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==23]<-126792  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1994/1/SCO2/39/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==23]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1994/1/SCO2/39/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==23]<-"Species_changed(DP)"
#length change 16.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1994/4/SCO2/1/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==30]<-126792  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1994/4/SCO2/1/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==30]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1994/4/SCO2/1/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==30]<-"Species_changed(DP)"
#length change 17.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1998/1/SCO3/55/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==29]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1998/1/SCO3/55/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==29]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1998/1/SCO3/55/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==29]<-"Species_changed(DP)"
#length change 18.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2010/1/SCO3/49/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==23]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2010/1/SCO3/49/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==23]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2010/1/SCO3/49/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==23]<-"Species_changed(DP)"
#length change 19.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2011/1/SCO3/29/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==24]<-126792  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2011/1/SCO3/29/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==24]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2011/1/SCO3/29/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==24]<-"Species_changed(DP)"
#length change 20.Callionymus maculatus to Callionymuslyra
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2011/3/SCO3/34/GOV"&
                         dat4$ValidAphiaID==126793&
                         dat4$newLngtClass==23]<-126792  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2011/3/SCO3/34/GOV"&
                  dat4$ValidAphiaID==126793&
                  dat4$newLngtClass==23]<-"Callionymus lyra"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2011/3/SCO3/34/GOV"&
                 dat4$ValidAphiaID==126793&dat4$newLngtClass==23]<-"Species_changed(DP)"
#length change 21.Echiichthys vipera to Trachinus draco 
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2005/1/SCO3/32/GOV"&
                         dat4$ValidAphiaID==150630&
                         dat4$newLngtClass==23]<-127082  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2005/1/SCO3/32/GOV"&
                  dat4$ValidAphiaID==150630&
                  dat4$newLngtClass==23]<-"Trachinus draco"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2005/1/SCO3/32/GOV"&
                 dat4$ValidAphiaID==150630&dat4$newLngtClass==23]<-"Species_changed(DP)"
#length change 22.Echiichthys vipera to Trachinus draco 
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2005/1/SCO3/32/GOV"&
                         dat4$ValidAphiaID==150630&
                         dat4$newLngtClass==24]<-127082  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2005/1/SCO3/32/GOV"&
                  dat4$ValidAphiaID==150630&
                  dat4$newLngtClass==24]<-"Trachinus draco"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2005/1/SCO3/32/GOV"&
                 dat4$ValidAphiaID==150630&dat4$newLngtClass==24]<-"Species_changed(DP)"
#length change 23.Gymnammodytes semisquamatus
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2006/4/SCO3/14/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==145]<-14.5 
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2006/4/SCO3/14/GOV"&
                 dat4$ValidAphiaID==126754&dat4$LngtClass==145]<-"Length_changed(DP)"
#length change 24.Gymnammodytes semisquamatus
list<-c('SWC-IBTS/2006/4/SCO3/14/GOV','NS-IBTS/2007/3/SCO3/23/GOV',
        'NS-IBTS/2007/3/SCO3/84/GOV','SWC-IBTS/2008/1/SCO3/38/GOV',
        'NS-IBTS/2008/3/SCO3/62/GOV','SWC-IBTS/2008/4/SCO3/3/GOV',
        'SWC-IBTS/2009/1/SCO3/50/GOV','NS-IBTS/2009/3/SCO3/38/GOV',
        'NS-IBTS/2009/3/SCO3/41/GOV','NS-IBTS/2009/3/SCO3/65/GOV',
        'SWC-IBTS/2009/4/SCO3/3/GOV','SWC-IBTS/2009/4/SCO3/4/GOV',
        'SWC-IBTS/2009/4/SCO3/56/GOV','NS-IBTS/2010/1/SCO3/36/GOV',
        'NS-IBTS/2010/1/SCO3/54/GOV','SWC-IBTS/2010/1/SCO3/32/GOV',
        'SWC-IBTS/2010/1/SCO3/33/GOV')
dat4$QC_Length[dat4$New_UniqueID%in%list&
                 dat4$ValidAphiaID==126754]<-"Length_changed(DP)"

dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2006/4/SCO3/14/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==145]<-14.5 

dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==170]<-17 
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==172]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==173]<-18.5 
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==174]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==175]<-19.5 
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==176]<-20 
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==177]<-20.5 
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==178]<-21
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==179]<-21.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/23/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==180]<-22
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==150]<-15
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==151]<-15.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==152]<-16
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==153]<-16.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==154]<-17
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==155]<-17.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==156]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==157]<-18.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==158]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==159]<-19.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==160]<-20
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==161]<-20.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==162]<-21
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==164]<-22
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2007/3/SCO3/84/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==165]<-22.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/1/SCO3/38/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==180]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2008/3/SCO3/62/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==160]<-16
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2008/3/SCO3/62/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==161]<-16.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2008/3/SCO3/62/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==162]<-17
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2008/3/SCO3/62/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==163]<-17.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2008/3/SCO3/62/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==164]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2008/3/SCO3/62/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==165]<-18.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2008/3/SCO3/62/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==166]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==170]<-17
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==171]<-17.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==172]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==173]<-18.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==174]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==175]<-19.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==176]<-20
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==177]<-20.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==178]<-21
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2008/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==179]<-21.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/1/SCO3/50/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==150]<-15
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/38/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==140]<-14
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/38/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==151]<-19.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/38/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==152]<-20
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/38/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==153]<-20.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/38/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==154]<-21
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/38/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==155]<-21.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==180]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==181]<-18.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==182]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==183]<-19.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==184]<-20
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==185]<-20.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==186]<-21
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==187]<-21.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==188]<-22
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==189]<-22.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==190]<-23
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/41/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==191]<-23.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2009/3/SCO3/65/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==185]<-18.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==90]<-9
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==92]<-10
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==93]<-10.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==94]<-11
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==95]<-11.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==96]<-12
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==97]<-12.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==99]<-13.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==101]<-14.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==103]<-15.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==104]<-16
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==105]<-16.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==106]<-17
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==107]<-17.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==108]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==109]<-18.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==110]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==111]<-19.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/3/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==112]<-20
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/4/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==120]<-12
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/4/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==134]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/56/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==255]<-25.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2010/1/SCO3/36/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==215]<-21.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2010/1/SCO3/36/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==217]<-22.5
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/2010/1/SCO3/54/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==220]<-22
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==80]<-8
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==83]<-9.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==84]<-10
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==85]<-10.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==86]<-11
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==87]<-11.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==88]<-12
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==89]<-12.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==90]<-13
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/32/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==92]<-14
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==165]<-16.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==166]<-17
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==167]<-17.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==168]<-18
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==169]<-18.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==170]<-19
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==171]<-19.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==172]<-20
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==173]<-20.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==174]<-21
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==175]<-21.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==176]<-22
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==177]<-22.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==178]<-23
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==179]<-23.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==180]<-24
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2010/1/SCO3/33/GOV"
                  & dat4$ValidAphiaID==126754
                  & dat4$LngtClass==182]<-25
#change length of Hyperoplus lanceolatus problem in cruisefile
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2013/1/SCO3/55/GOV"
                  & dat4$ValidAphiaID==126755
                  & dat4$LngtClass==540]<-27
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2013/1/SCO3/55/GOV"
                  & dat4$ValidAphiaID==126755
                  & dat4$LngtClass==690]<-28.5
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/2013/1/SCO3/55/GOV"
                  & dat4$ValidAphiaID==126755
                  & dat4$LngtClass==490]<-26.5
#check length of Leucoraja naevus has been reuploaded
check<-dat4[dat4$Year==1989
            & dat4$ValidAphiaID==127139, ]
# reuploaded sucessfully 
#check 54cm Limanda limanda has been removed
check<-dat4[dat4$New_UniqueID=="NS-IBTS/2015/3/SCO3/223/GOV"
            & dat4$ValidAphiaID==127139, ]
# gone  
#check oversized Pearlside has been removed
check<-dat4[dat4$New_UniqueID=="SWC-IBTS/1997/1/SCO2/13/GOV"
            & dat4$ValidAphiaID==127312, ]
# still there remove or change to Pearlfish???
#length change 21.Echiichthys vipera to Trachinus draco 
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/53/GOV"&
                         dat4$ValidAphiaID==127147&
                         dat4$newLngtClass==22]<-127151 
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/53/GOV"&
                  dat4$ValidAphiaID==127147&
                  dat4$newLngtClass==22]<-"Zeugopterus punctatus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1991/1/SCO2/53/GOV"&
                 dat4$ValidAphiaID==127147&dat4$newLngtClass==22]<-"Species_changed(DP)"
#Both Species and length change 21.Raja clavata to D. batis 
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/1/SCO2/15/GOV"&
                         dat4$ValidAphiaID==105883&
                         dat4$newLngtClass==150]<-105869 
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/1/SCO2/15/GOV"&
                  dat4$ValidAphiaID==105883&
                  dat4$newLngtClass==150]<-"Dipturus batis"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/1/SCO2/15/GOV"&
                 dat4$ValidAphiaID==105883&dat4$newLngtClass==198]<-"Species&Lenght_changed(DP)"
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/1992/1/SCO2/15/GOV"
                  & dat4$ValidAphiaID==105883
                  & dat4$LngtClass==150]<-198
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1994/1/SCO2/27/GOV"&
                         dat4$ValidAphiaID==105883&
                         dat4$newLngtClass==150]<-105869 
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1994/1/SCO2/27/GOV"&
                  dat4$ValidAphiaID==105883&
                  dat4$newLngtClass==150]<-"Dipturus batis"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1994/1/SCO2/27/GOV"&
                 dat4$ValidAphiaID==105883&dat4$newLngtClass==205]<-"Species&Lenght_changed(DP)"
dat4$FishLength_cm[dat4$New_UniqueID=="SWC-IBTS/1994/1/SCO2/27/GOV"
                  & dat4$ValidAphiaID==105883
                  & dat4$LngtClass==150]<-205
#Species change 21.Raja clavata to D. batis 
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2000/4/SCO3/1/GOV"&
                         dat4$ValidAphiaID==105883&
                         dat4$newLngtClass==207]<-105869 
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2000/4/SCO3/1/GOV"&
                  dat4$ValidAphiaID==105883&
                  dat4$newLngtClass==207]<-"Dipturus batis"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2000/4/SCO3/1/GOV"&
                 dat4$ValidAphiaID==105883&dat4$newLngtClass==207]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/63/GOV"&
                         dat4$ValidAphiaID==105883&
                         dat4$newLngtClass==141]<-105869 
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/63/GOV"&
                  dat4$ValidAphiaID==105883&
                  dat4$newLngtClass==141]<-"Dipturus batis"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/63/GOV"&
                 dat4$ValidAphiaID==105883&dat4$newLngtClass==141]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/74/GOV"&
                         dat4$ValidAphiaID==105883&
                         dat4$newLngtClass==128]<-105869 
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/74/GOV"&
                  dat4$ValidAphiaID==105883&
                  dat4$newLngtClass==128]<-"Dipturus batis"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2009/4/SCO3/74/GOV"&
                 dat4$ValidAphiaID==105883&dat4$newLngtClass==128]<-"Species_changed(DP)"
#Species change 21.Raja montagui to Raja brachyura
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1990/4/SCO2/45/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==95]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1990/4/SCO2/45/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==95]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1990/4/SCO2/45/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==95]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/7/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==94]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/7/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==94]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/7/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==94]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==94]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==94]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==94]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==97]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==97]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==97]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==101]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==101]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/36/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==101]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/37/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==96]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/37/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==96]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/37/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==96]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/37/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==103]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/37/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==103]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/37/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==103]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/40/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==97]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/40/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==97]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/1992/4/SCO2/40/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==97]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="SWC-IBTS/2013/1/SCO3/11/GOV"&
                         dat4$ValidAphiaID==105887&
                         dat4$newLngtClass==101]<-367297  
dat4$estsciname[dat4$New_UniqueID=="SWC-IBTS/2013/1/SCO3/11/GOV"&
                  dat4$ValidAphiaID==105887&
                  dat4$newLngtClass==101]<-"Raja brachyura"
dat4$QC_Length[dat4$New_UniqueID=="SWC-IBTS/2013/1/SCO3/11/GOV"&
                 dat4$ValidAphiaID==105887&dat4$newLngtClass==101]<-"Species_changed(DP)"
# change Taurulus bubalis to Myoxocephalus scorpius
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1987/1/SCO2/34/GOV"&
                         dat4$ValidAphiaID==127204&
                         dat4$newLngtClass==25]<-127203  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1987/1/SCO2/34/GOV"&
                  dat4$ValidAphiaID==127204&
                  dat4$newLngtClass==25]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1987/1/SCO2/34/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==25]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1987/1/SCO2/34/GOV"&
                         dat4$ValidAphiaID==127204&
                         dat4$newLngtClass==27]<-127203  
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1987/1/SCO2/34/GOV"&
                  dat4$ValidAphiaID==127204&
                  dat4$newLngtClass==27]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1987/1/SCO2/34/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==27]<-"Species_changed(DP)"
# Norway corrections
# change Taurulus bubalis to Myoxocephalus scorpius
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                         dat4$ValidAphiaID==127072 &
                         dat4$newLngtClass==24]<-154675   
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                  dat4$ValidAphiaID==127072 &
                  dat4$newLngtClass==24]<-"Lumpenus lampretaeformis"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==24]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                         dat4$ValidAphiaID==127072 &
                         dat4$newLngtClass==26]<-154675   
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                  dat4$ValidAphiaID==127072 &
                  dat4$newLngtClass==26]<-"Lumpenus lampretaeformis"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==26]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                         dat4$ValidAphiaID==127072 &
                         dat4$newLngtClass==27]<-154675   
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                  dat4$ValidAphiaID==127072 &
                  dat4$newLngtClass==27]<-"Lumpenus lampretaeformis"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==27]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                         dat4$ValidAphiaID==127072 &
                         dat4$newLngtClass==28]<-154675   
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                  dat4$ValidAphiaID==127072 &
                  dat4$newLngtClass==28]<-"Lumpenus lampretaeformis"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==28]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                         dat4$ValidAphiaID==127072 &
                         dat4$newLngtClass==29]<-154675   
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                  dat4$ValidAphiaID==127072 &
                  dat4$newLngtClass==29]<-"Lumpenus lampretaeformis"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/3/MIC/556/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==29]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1996/1/MIC/5/GOV"&
                         dat4$ValidAphiaID==271564  &
                         dat4$newLngtClass==70]<-105870    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1996/1/MIC/5/GOV"&
                  dat4$ValidAphiaID==271564  &
                  dat4$newLngtClass==70]<-"Dipturus linteus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1996/1/MIC/5/GOV"&
                 dat4$ValidAphiaID==271564 &dat4$newLngtClass==70]<-"Species_changed(DP)"
# remove record of Lycodes gracilis
dat4<-dat4[ !(dat4$New_UniqueID=="NS-IBTS/2006/3/JHJ/287/GOV"&
                dat4$ValidAphiaID==274100   &
                dat4$newLngtClass==56),]
# remove record of Sebastes viviparus
dat4<-dat4[ !(dat4$New_UniqueID=="ROCKALL/2014/3/SCO3/311/GOV"&
                dat4$ValidAphiaID==127255   &
                dat4$newLngtClass==50),]
# EVHOE Length Corrections
# change Species
dat4$estAphia_Code[dat4$New_UniqueID=="EVHOE/2014/4/THA2/120/GOV"&
                         dat4$ValidAphiaID==272278  &
                         dat4$newLngtClass==12]<-272728     
dat4$estsciname[dat4$New_UniqueID=="EVHOE/2014/4/THA2/120/GOV"&
                  dat4$ValidAphiaID==272278  &
                  dat4$newLngtClass==12]<-"Notoscopelus kroyeri"
dat4$QC_Length[dat4$New_UniqueID=="EVHOE/2014/4/THA2/120/GOV"&
                 dat4$ValidAphiaID==272278 & 
                 dat4$newLngtClass==12]<-"Species_changed(DP)"
# Change length 
check<-dat4[dat4$New_UniqueID=="EVHOE/2002/4/THA2/41/GOV"&
              dat4$ValidAphiaID==126976,]
# only 2 that need changing
dat4$QC_Length[dat4$New_UniqueID=="EVHOE/2002/4/THA2/41/GOV"&
                 dat4$ValidAphiaID==126976]<-"Length_changed(DP)"
dat4$FishLength_cm[dat4$New_UniqueID=="EVHOE/2002/4/THA2/41/GOV"
                  & dat4$ValidAphiaID==126976
                  & dat4$LngtClass==93]<-33 
dat4$FishLength_cm[dat4$New_UniqueID=="EVHOE/2002/4/THA2/41/GOV"
                  & dat4$ValidAphiaID==126976
                  & dat4$LngtClass==96]<-36 
# Change length 
check<-dat4[dat4$New_UniqueID=="EVHOE/2013/4/THA2/23/GOV"&
              dat4$ValidAphiaID==126413,]
# only 1 that need changing
dat4$QC_Length[dat4$New_UniqueID=="EVHOE/2013/4/THA2/23/GOV"&
                 dat4$ValidAphiaID==126413]<-"Length_changed(DP)"
dat4$FishLength_cm[dat4$New_UniqueID=="EVHOE/2013/4/THA2/23/GOV"
                  & dat4$ValidAphiaID==126413
                  & dat4$LngtClass==260]<-26 

# Change length 
check<-dat4[dat4$New_UniqueID=="EVHOE/2013/4/THA2/21/GOV"&
              dat4$ValidAphiaID==126415,]
# only 1 that need changing
dat4$QC_Length[dat4$New_UniqueID=="EVHOE/2013/4/THA2/21/GOV"&
                 dat4$ValidAphiaID==126415]<-"Length_changed(DP)"
dat4$FishLength_cm[dat4$New_UniqueID=="EVHOE/2013/4/THA2/21/GOV"
                  & dat4$ValidAphiaID==126415
                  & dat4$LngtClass==420]<-42
# England corrections  check
# Probably wrongly swiped on measuring board. 
# Could not delete length from FSS, as this would affect weight.
check<-dat4[dat4$New_UniqueID=="BTS-VIIa/2007/3/COR/45/BT4A"&
              dat4$ValidAphiaID==127126,]
# still in database
#delete 
dat4<-dat4[ !(dat4$New_UniqueID=="BTS-VIIa/2007/3/COR/45/BT4A"&
                dat4$ValidAphiaID==127126   &
                dat4$newLngtClass==44),]
# Probable typo. Probably SDR (spotted ray) and not SPR. 
# The catch was also sexed. Changed to SDR on FSS
# Check
check<-dat4[dat4$New_UniqueID=="BTS/2009/4/CAR/55/BT4A" & 
              dat4$ValidAphiaID==126425,]
# Ship CAR already removed
check<-dat4[dat4$New_UniqueID=="BTS/2003/3/COR/99/BT4A" & 
              dat4$ValidAphiaID==126445 &
              dat4$newLngtClass==88,]
# Probably wrongly swiped on measuring board. 
# Correction captured previously. Deleted from FSS
# needs to be removed from dataset
dat4<-dat4[!(dat4$New_UniqueID=="BTS/2003/3/COR/99/BT4A" & 
               dat4$ValidAphiaID==126445 &
               dat4$newLngtClass==88),]
check<-dat4[dat4$New_UniqueID=="BTS/2013/3/END/90/BT4A" & 
              dat4$ValidAphiaID==127126 &
              dat4$newLngtClass==43,]
dat4<-dat4[!(dat4$New_UniqueID=="BTS/2013/3/END/90/BT4A" & 
               dat4$ValidAphiaID==127126 &
               dat4$newLngtClass==43),]

check<-dat4[dat4$New_UniqueID=="BTS/2008/3/END/80/BT4A" & 
              dat4$ValidAphiaID==127153 &
              dat4$newLngtClass==50,]
dat4<-dat4[!(dat4$New_UniqueID=="BTS/2008/3/END/80/BT4A" & 
               dat4$ValidAphiaID==127153 &
               dat4$newLngtClass==50),]
check<-dat4[dat4$New_UniqueID=="BTS/2010/3/END/4/BT4A" & 
              dat4$ValidAphiaID==127153,]
dat4<-dat4[!(dat4$New_UniqueID=="BTS/2010/3/END/4/BT4A" & 
               dat4$ValidAphiaID==127153 &
               dat4$newLngtClass==38),]
# gone
check<-dat4[dat4$New_UniqueID=="BTS/2002/3/COR/12/BT4A" & 
              dat4$ValidAphiaID==274304,]
dat4<-dat4[!(dat4$New_UniqueID=="BTS/2002/3/COR/12/BT4A" & 
               dat4$ValidAphiaID==274304 &
               dat4$newLngtClass==56),]
# CGFS - errors in lmax
# yves has sent me lots of corrections 
# get these included.
# Change Alosa agone to Alosa fallax
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2005/1/THA2/53/GOV"&
                         dat4$ValidAphiaID==416357 &
                         dat4$newLngtClass==46]<-126415     
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2005/1/THA2/53/GOV"&
                  dat4$ValidAphiaID==416357 &
                  dat4$newLngtClass==46]<-"Alosa fallax"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2005/1/THA2/53/GOV"&
                 dat4$ValidAphiaID==416357&dat4$newLngtClass==46]<-"Species_changed(DP)"
# Change Alosa agone to Alosa fallax
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2006/1/THA2/16/GOV"&
                         dat4$ValidAphiaID==416357 &
                         dat4$newLngtClass==43]<-126415     
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2006/1/THA2/16/GOV"&
                  dat4$ValidAphiaID==416357 &
                  dat4$newLngtClass==43]<-"Alosa fallax"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2006/1/THA2/16/GOV"&
                 dat4$ValidAphiaID==416357&dat4$newLngtClass==43]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2009/1/THA2/79/GOV"&
                         dat4$ValidAphiaID==416357 &
                         dat4$newLngtClass==43]<-126415     
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2009/1/THA2/79/GOV"&
                  dat4$ValidAphiaID==416357 &
                  dat4$newLngtClass==43]<-"Alosa fallax"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2009/1/THA2/79/GOV"&
                 dat4$ValidAphiaID==416357&dat4$newLngtClass==43]<-"Species_changed(DP)"
# change Sprattus sprattus to Clupea Harengus
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1983/1/THA/8/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==18]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1983/1/THA/8/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==18]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1983/1/THA/8/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==18]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==19.5]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==19.5]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==19.5]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==20]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==20]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==20]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==20.5]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==20.5]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==20.5]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==21]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==21]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==21]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==21.5]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==21.5]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==21.5]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==22]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==22]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==22]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==22.5]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==22.5]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==22.5]<-"Species_changed(DP)"
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==23]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==23]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==23]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==23.5]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==23.5]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==23.5]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                         dat4$ValidAphiaID==126425 &
                         dat4$newLngtClass==24.5]<-126417    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                  dat4$ValidAphiaID==126425 &
                  dat4$newLngtClass==24.5]<-"Clupea harengus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/17/GOV"&
                 dat4$ValidAphiaID==126425&dat4$newLngtClass==24.5]<-"Species_changed(DP)"
# change Taurulus bubalis to Myoxocephalus scorpius
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/31/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass==21]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/31/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass==21]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/31/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==21]<-"Species_changed(DP)"


dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/31/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass==23]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/31/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass==23]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/31/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==23]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/39/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass==30]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/39/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass==30]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1992/1/THA/39/GOV"&
                 dat4$ValidAphiaID==127204&dat4$newLngtClass==30]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/24/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass>19.9]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/24/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass>19.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/24/GOV"&
                 dat4$ValidAphiaID>127204&dat4$newLngtClass>19.9]<-"Species_changed(DP)"

check<-test[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/24/GOV"&
              dat4$ValidAphiaID==127204,]

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/26/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass>19.9]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/26/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass>19.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/26/GOV"&
                 dat4$ValidAphiaID>127204&dat4$newLngtClass>19.9]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/26/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass>19.9]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/26/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass>19.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1995/1/THA/26/GOV"&
                 dat4$ValidAphiaID>127204&dat4$newLngtClass>19.9]<-"Species_changed(DP)"

list<-c('NS-IBTS/1995/1/THA/27/GOV', 'NS-IBTS/1995/1/THA/28/GOV',
        'NS-IBTS/1995/1/THA/35/GOV', 'NS-IBTS/1995/1/THA/36/GOV',
        'NS-IBTS/1995/1/THA/38/GOV', 'NS-IBTS/1995/1/THA/8/GOV',
        'NS-IBTS/1996/1/THA/17/GOV', 'NS-IBTS/1996/1/THA/2/GOV',
        'NS-IBTS/1996/1/THA/24/GOV', 'NS-IBTS/1996/1/THA/25/GOV',
        'NS-IBTS/1996/1/THA/3/GOV', 'NS-IBTS/1996/1/THA/37/GOV',
        'NS-IBTS/1996/1/THA/7/GOV', 'NS-IBTS/1997/1/THA2/13/GOV',
        'NS-IBTS/1997/1/THA2/23/GOV', 'NS-IBTS/1997/1/THA2/24/GOV',
        'NS-IBTS/1997/1/THA2/26/GOV', 'NS-IBTS/1997/1/THA2/31/GOV',
        'NS-IBTS/1997/1/THA2/41/GOV', 'NS-IBTS/1997/1/THA2/53/GOV',
        'NS-IBTS/1997/1/THA2/54/GOV', 'NS-IBTS/1997/1/THA2/59/GOV',
        'NS-IBTS/1998/1/THA2/1/GOV', 'NS-IBTS/1998/1/THA2/30/GOV',
        'NS-IBTS/1998/1/THA2/39/GOV', 'NS-IBTS/1998/1/THA2/40/GOV',
        'NS-IBTS/1998/1/THA2/41/GOV', 'NS-IBTS/1998/1/THA2/42/GOV',
        'NS-IBTS/1998/1/THA2/58/GOV', 'NS-IBTS/1998/1/THA2/59/GOV',
        'NS-IBTS/1998/1/THA2/61/GOV', 'NS-IBTS/1998/1/THA2/71/GOV',
        'NS-IBTS/1998/1/THA2/73/GOV', 'NS-IBTS/1998/1/THA2/82/GOV',
        'NS-IBTS/1998/1/THA2/83/GOV', 'NS-IBTS/1999/1/THA2/2/GOV',
        'NS-IBTS/1999/1/THA2/27/GOV', 'NS-IBTS/1999/1/THA2/30/GOV',
        'NS-IBTS/1999/1/THA2/32/GOV', 'NS-IBTS/1999/1/THA2/34/GOV',
        'NS-IBTS/1999/1/THA2/35/GOV', 'NS-IBTS/1999/1/THA2/5/GOV',
        'NS-IBTS/1999/1/THA2/7/GOV', 'NS-IBTS/1999/1/THA2/8/GOV',
        'NS-IBTS/2000/1/THA2/1/GOV', 'NS-IBTS/2000/1/THA2/2/GOV',
        'NS-IBTS/2000/1/THA2/30/GOV', 'NS-IBTS/2000/1/THA2/31/GOV',
        'NS-IBTS/2000/1/THA2/32/GOV', 'NS-IBTS/2000/1/THA2/41/GOV',
        'NS-IBTS/2000/1/THA2/42/GOV', 'NS-IBTS/2000/1/THA2/43/GOV')

dat4$estAphia_Code[dat4$New_UniqueID%in%list&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass>19.9]<-127203    
dat4$estsciname[dat4$New_UniqueID%in%list&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass>19.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID%in%list&
                 dat4$ValidAphiaID>127204&dat4$newLngtClass>19.9]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2004/1/THA2/29/GOV"&
                         dat4$ValidAphiaID==127202 &
                         dat4$newLngtClass>24.9]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2004/1/THA2/29/GOV"&
                  dat4$ValidAphiaID==127202 &
                  dat4$newLngtClass>24.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2004/1/THA2/29/GOV"&
                 dat4$ValidAphiaID>127202&dat4$newLngtClass>24.9]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2006/1/THA2/41/GOV"&
                         dat4$ValidAphiaID==127202 &
                         dat4$newLngtClass>26.9]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2006/1/THA2/41/GOV"&
                  dat4$ValidAphiaID==127202 &
                  dat4$newLngtClass>26.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2006/1/THA2/41/GOV"&
                 dat4$ValidAphiaID>127202&dat4$newLngtClass>26.9]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2014/1/THA2/87/GOV"&
                         dat4$ValidAphiaID==127202 &
                         dat4$newLngtClass==25]<-127203    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2014/1/THA2/87/GOV"&
                  dat4$ValidAphiaID==127202 &
                  dat4$newLngtClass==25]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2014/1/THA2/87/GOV"&
                 dat4$ValidAphiaID>127202&dat4$newLngtClass==25]<-"Species_changed(DP)"
# Nerophis ophidion - Possible confusion with Entelurus aequoreus
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2005/1/THA2/42/GOV"&
                         dat4$ValidAphiaID==127385 &
                         dat4$newLngtClass==38]<-127379    
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2005/1/THA2/42/GOV"&
                  dat4$ValidAphiaID==127385 &
                  dat4$newLngtClass==38]<-"Entelurus aequoreus"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2005/1/THA2/42/GOV"&
                 dat4$ValidAphiaID==127385&dat4$newLngtClass==38]<-"Species_changed(DP)"

list<-c('NS-IBTS/2005/1/THA2/42/GOV', 'NS-IBTS/2005/1/THA2/44/GOV',
        'NS-IBTS/2005/1/THA2/47/GOV', 'NS-IBTS/2005/1/THA2/55/GOV',
        'NS-IBTS/2005/1/THA2/58/GOV', 'NS-IBTS/2005/1/THA2/59/GOV',
        'NS-IBTS/2005/1/THA2/67/GOV', 'NS-IBTS/2005/1/THA2/70/GOV')

dat4$estAphia_Code[dat4$New_UniqueID%in%list&
                         dat4$ValidAphiaID==127385 &
                         dat4$newLngtClass>35.9]<-127379    
dat4$estsciname[dat4$New_UniqueID%in%list&
                  dat4$ValidAphiaID==127385 &
                  dat4$newLngtClass==35.9]<-"Entelurus aequoreus"
dat4$QC_Length[dat4$New_UniqueID%in%list&
                 dat4$ValidAphiaID==127385&dat4$newLngtClass==35.9]<-"Species_changed(DP)"
# change Ammodytes tobianus to  Hyperoplus immaculatus
list<-c("NS-IBTS/1998/1/THA2/68/GOV","NS-IBTS/1998/1/THA2/69/GOV",
        'NS-IBTS/1998/1/THA2/71/GOV','NS-IBTS/1998/1/THA2/72/GOV',
        'NS-IBTS/1998/1/THA2/73/GOV','NS-IBTS/1998/1/THA2/75/GOV',
        'NS-IBTS/2001/1/THA2/5/GOV','NS-IBTS/2003/1/THA2/7/GOV',
        'NS-IBTS/2004/1/THA2/40/GOV','NS-IBTS/2006/1/THA2/36/GOV',
        'NS-IBTS/2008/1/THA2/77/GOV','NS-IBTS/2009/1/THA2/13/GOV',
        'NS-IBTS/2009/1/THA2/14/GOV','NS-IBTS/2010/1/THA2/91/GOV',
        'NS-IBTS/2011/1/THA2/83/GOV')

dat4$estAphia_Code[dat4$New_UniqueID%in%list&
                         dat4$ValidAphiaID==126752 &
                         dat4$newLngtClass>22.9]<-126755     
dat4$estsciname[dat4$New_UniqueID%in%list&
                  dat4$ValidAphiaID==126752 &
                  dat4$newLngtClass>22.9]<-"Hyperoplus immaculatus"
dat4$QC_Length[dat4$New_UniqueID%in%list&
                 dat4$ValidAphiaID==126752&dat4$newLngtClass>22.9]<-"Species_changed(DP)"
# more Taurulus bubalis to Myoxocephalus scorpius
dat4$estAphia_Code[dat4$New_UniqueID=="FR-CGFS/1997/4/GWD/1/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass>19.9]<-127203
dat4$estsciname[dat4$New_UniqueID=="FR-CGFS/1997/4/GWD/1/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass>19.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="FR-CGFS/1997/4/GWD/1/GOV"&
                 dat4$ValidAphiaID==127203 & dat4$newLngtClass>19.9]<-"Species_changed(DP)"

dat4$estAphia_Code[dat4$New_UniqueID=="FR-CGFS/2005/4/GWD/11/GOV"&
                         dat4$ValidAphiaID==127204 &
                         dat4$newLngtClass>19.9]<-127203
dat4$estsciname[dat4$New_UniqueID=="FR-CGFS/2005/4/GWD/11/GOV"&
                  dat4$ValidAphiaID==127204 &
                  dat4$newLngtClass>19.9]<-"Myoxocephalus scorpius"
dat4$QC_Length[dat4$New_UniqueID=="FR-CGFS/2005/4/GWD/11/GOV"&
                 dat4$ValidAphiaID==127203 & dat4$newLngtClass>19.9]<-"Species_changed(DP)"
# Liparis montagui is probably Liparis liparis 
list<-c('NS-IBTS/1999/1/THA2/3/GOV',  'NS-IBTS/2000/1/THA2/43/GOV',
        'NS-IBTS/2002/1/THA2/68/GOV', 'NS-IBTS/2002/1/THA2/69/GOV')

dat4$estAphia_Code[dat4$New_UniqueID%in%list&dat4$ValidAphiaID==127220 
                       & dat4$newLngtClass>13.9]<-293624 
dat4$estsciname[dat4$New_UniqueID%in%list & dat4$ValidAphiaID==127220 
                & dat4$newLngtClass>13.9]<-"Liparis liparis liparis"
dat4$QC_Length[dat4$New_UniqueID%in%list & dat4$ValidAphiaID==127220
               & dat4$newLngtClass>13.9]<-"Species_changed(DP)"
# Buglossidium luteum is probably Solea solea
dat4$estAphia_Code[dat4$New_UniqueID=="NS-IBTS/2000/1/THA2/68/GOV"
                       &dat4$ValidAphiaID==127153
                       & dat4$newLngtClass>19.9]<-127160 
dat4$estsciname[dat4$New_UniqueID=="NS-IBTS/2000/1/THA2/68/GOV"
                & dat4$ValidAphiaID==127153
                & dat4$newLngtClass>19.9]<-"Solea solea"
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/2000/1/THA2/68/GOV"
               & dat4$ValidAphiaID==127153
               & dat4$newLngtClass>19.9]<-"Species_changed(DP)"
# Symphodus roissali probably another Symphodus spp 
dat4$estAphia_Code[dat4$New_UniqueID=="FR-CGFS/2014/4/GWD/6/GOV"
                       &dat4$ValidAphiaID==273573
                       & dat4$newLngtClass>28.9]<-126023 
dat4$estsciname[dat4$New_UniqueID=="FR-CGFS/2014/4/GWD/6/GOV"
                & dat4$ValidAphiaID==273573
                & dat4$newLngtClass>28.9]<-"Symphodus"
dat4$QC_Length[dat4$New_UniqueID=="FR-CGFS/2014/4/GWD/6/GOV"
               & dat4$ValidAphiaID==273573
               & dat4$newLngtClass>28.9]<-"Species_changed_to_genus(DP)"
# two lenghts need changing 
dat4$FishLength_cm[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/61/GOV"
                  & dat4$ValidAphiaID==126415
                  & dat4$LngtClass==110]<-11 
dat4$QC_Length[dat4$New_UniqueID=="NS-IBTS/1999/1/THA2/61/GOV"&
                 dat4$ValidAphiaID==126415&dat4$LngtClass==110]<-"Length_changed(DP)"
dat4$FishLength_cm[dat4$New_UniqueID=="FR-CGFS/2006/4/GWD/47/GOV"
                  & dat4$ValidAphiaID==127126
                  & dat4$LngtClass==150]<-15 
dat4$QC_Length[dat4$New_UniqueID=="FR-CGFS/2006/4/GWD/47/GOV"&
                 dat4$ValidAphiaID==127126&dat4$LngtClass==150]<-"Length_changed(DP)"
#######################
# Check LMax - step 2 #
#######################
# Fill in rest of data into new Valid name and id and QC length
summary(as.factor(dat4$QC_Length))
dat4$QC_Length[is.na(dat4$QC_Length)]<-"no_change"
# redo max data on new spp names 
names(traits)
names(dat4)
traits$estsciname<-traits$valid_name
dat4$LmaxFB<-NULL
dat4$valid_name<-NULL
dat4$valid_authority<-NULL
dat4$kingdom<-NULL
dat4$phylum<-NULL
dat4$order<-NULL
dat4$family<-NULL
dat4$genus<-NULL
dat4$rank<-NULL
dat4$FRS_Common.Name<-NULL
dat4$CLASS<-NULL
# new data frame
names(dat4)
dat5<-join(dat4, traits, by="estsciname")
nrow(dat4)-nrow(dat5)
names(dat5)

test1<-dat5[which(dat5$newLngtClass > dat5$LmaxFB*1.1),]
# 1962 observations 

test2<-dat5[which(dat5$newLngtClass > dat5$LmaxFB*1.4),]
# 354 observations
summary(as.factor(test2$Country))
summary(as.factor(test2$estsciname))
summary(as.factor(test2$estrank))

Problem_Lenghts<-ddply(test1[!is.na(HLNoAtLngtkm2)],
                       c("Survey", "Year", "estsciname", "rank"),
                       summarise, 
                       totalnopofsamples=length(as.numeric(HLNoAtLngtkm2)))
write.csv(Problem_Lenghts, "Summary_probelm_lengths_10-10-2016.csv")
summarysppnosatLngtperyerandcon<-ddply(dat5[!is.na(HLNoAtLngtkm2)],
                                       c("valid_name", "rank", 
                                         "Country", "Year",
                                         "newLngtClass"),
                                       summarise, totalnopofsamples=length(as.numeric(HLNoAtLngtkm2)))
write.csv(summarysppnosatLngtperyerandcon, "Summary_Fish_at_Length.csv")
# take a copy of the lengths
dat5$newLngtClass_10<-dat5$newLngtClass/10
# next fit all the Coelorinchus caelorhincus lenghts
list<-c('Length_changed(DP)', 'no_change','Species&Lenght_changed(DP)',
        'Species_changed(DP)', 'Species_changed_to_genus(DP)' )
dat5$Use_Lenght_cm[dat5$QC_Length%in%list]<- dat5$FishLength_cm[dat5$QC_Length%in%list]
summary(dat5$Use_Lenght_cm)
# have we got them all now?
test1 <- dat5[ which(dat5$Use_Lenght_cm > dat5$LmaxFB*1.1),]
# still 2052 
test2<-dat5[ which(dat5$Use_Lenght_cm > dat5$LmaxFB*1.4),]
# 305 are outwith criteria for "big fish" 
summary(as.factor(test1$Survey))
# again spain is causing the major concens here
summary(dat5$LmaxFB)
write.csv(test2, "more_lenghts_to_check-10-10-2016.csv")
#lets get these ones sorted out
# more Engraulis encrasicolus needing division
list<-c("NS-IBTS/2000/3/DAN2/31/GOV", "NS-IBTS/2000/3/DAN2/31/GOV", 
        "NS-IBTS/2000/3/DAN2/31/GOV", "NS-IBTS/2000/3/DAN2/31/GOV", 
        "NS-IBTS/2005/3/WAH3/151/GOV")
find<-dat5[dat5$New_UniqueID%in%list &
             dat5$ValidAphiaID==126426]
dat5$QC_Length[dat5$New_UniqueID%in%list&
                 dat5$ValidAphiaID==126426]<-"Length/10"
find<-dat5[dat5$New_UniqueID=="PT-IBTS/2013/4/NOR/73/NCT" &
             dat5$ValidAphiaID==126426 & dat5$newLngtClass==155]
dat5$QC_Length[dat5$New_UniqueID=="PT-IBTS/2013/4/NOR/73/NCT" &
                 dat5$ValidAphiaID==126426 & dat5$newLngtClass==155]<-"Length/10"
find<-subset(dat5, dat5$New_UniqueID=="NS-IBTS/1995/1/WAH3/1/GOV",)
# Callionymus maculatus oversized records
cm<-subset(dat5, ValidAphiaID==126793,)
plot(cm$Use_Lenght_cm, cm$HLNoAtLngtkm2)
# issue with the really big ones about 150 obs. 
list<-c("IE-IGFS/2008/4/CEXP/84/GOV","NS-IBTS/2000/1/ARG/27/GOV",
        "EVHOE/2003/4/THA2/134/GOV","NIGFS/1998/3/LF/33/ROT",	
        "NS-IBTS/1995/1/WAH3/1/GOV","IE-IGFS/2004/4/CEXP/135/GOV",
        "EVHOE/2008/4/THA2/134/GOV","EVHOE/1998/4/THA2/126/GOV",	
        "NS-IBTS/2007/1/WAH3/24/GOV",	"NS-IBTS/1991/1/TRI2/20/GOV",
        "NS-IBTS/2004/1/THA2/24/GOV","IE-IGFS/2004/4/CEXP/19/GOV",
        "NS-IBTS/1991/1/TRI2/7/GOV","IE-IGFS/2005/4/CEXP/3/GOV",
        "EVHOE/2001/4/THA2/102/GOV","NS-IBTS/2004/3/HAV/314/GOV",
        "IE-IGFS/2005/4/CEXP/4/GOV","NS-IBTS/2001/3/CIR/69/GOV",
        "NS-IBTS/1995/1/WAH3/4/GOV","IE-IGFS/2005/3/CEXP/4/GOV",
        "IE-IGFS/2005/3/CEXP/3/GOV")
find<-dat5[dat5$New_UniqueID%in%list &
             dat5$ValidAphiaID==126793]
# more likely to be C. Lyra at that size not C.maculatus
dat5$estAphia_Code[dat5$New_UniqueID%in%list&
                         dat5$ValidAphiaID==126793 &
                         dat5$newLngtClass>16]<-126792      
dat5$estsciname[dat5$New_UniqueID%in%list&
                  dat5$ValidAphiaID==126793  &
                  dat5$newLngtClass>16]<-"Callionymus lyra"
dat5$QC_Length[dat5$New_UniqueID%in%list&
                 dat5$ValidAphiaID==126793 &
                 dat5$newLngtClass>16]<-"Species_changed(DP)"

cr<-subset(dat5, ValidAphiaID==126795,)
plot(cr$Use_Lenght_cm, cr$HLNoAtLngtkm2)
list<-c('NS-IBTS/1991/1/TRI2/20/GOV','NS-IBTS/2004/1/THA2/24/GOV',
        'IE-IGFS/2004/4/CEXP/19/GOV','NS-IBTS/1991/1/TRI2/7/GOV',
        'IE-IGFS/2005/4/CEXP/3/GOV','NS-IBTS/2004/3/HAV/314/GOV',
        'IE-IGFS/2005/4/CEXP/4/GOV','NS-IBTS/2001/3/CIR/69/GOV',
        'IE-IGFS/2005/3/CEXP/4/GOV','IE-IGFS/2005/3/CEXP/3/GOV')
find<-dat5[dat5$New_UniqueID%in%list &
             dat5$ValidAphiaID==126795&dat5$Use_Lenght_cm>11,]

dat5$estAphia_Code[dat5$New_UniqueID%in%list&
                         dat5$ValidAphiaID==126795 &
                         dat5$newLngtClass>14]<-126792      
dat5$estsciname[dat5$New_UniqueID%in%list&
                  dat5$ValidAphiaID==126795  &
                  dat5$newLngtClass>14]<-"Callionymus lyra"
dat5$QC_Length[dat5$New_UniqueID%in%list&
                 dat5$ValidAphiaID==126795 &
                 dat5$newLngtClass>14]<-"Species_changed(DP)"
plot(dat5$Use_Lenght_cm[dat5$estAphia_Code==126795], 
     dat5$HLNoAtLngtkm2[dat5$estAphia_Code==126795])
# that looks grand and sensible, nach bhfuil muid go hiontach 
summary(as.factor(cm$Survey))
at<-subset(dat5, ValidAphiaID==126752,)
plot(at$Use_Lenght_cm, at$HLNoAtLngtkm2)
am<-subset(dat5,ValidAphiaID==126751, )
plot(am$Use_Lenght_cm, am$HLNoAtLngtkm2)
20*1.4
25*1.4
# as the Ammodytes tobianus and marinus will be combine to family levels
# I'll leave lenghts as is long A.tobianus  missidentified A.marinus or Hyperoplus
# no brainer for Notoscopelus kroyeri
# second pass
nb<-subset(dat5, ValidAphiaID==126642,)
summary(as.factor(nb$Country))
summary(as.factor((nb$Survey)))
cols<-rainbow(4)

plot(dat5$Use_Lenght_cm[dat5$ValidAphiaID==126642], 
     dat5$HLNoAtLngtkm2[dat5$ValidAphiaID==126642],
     pch=19, col="green")
summary(dat5$newLngtClass)

find<-dat5[dat5$New_UniqueID=="NS-IBTS/2016/1/SCO3/46/GOV" &
             dat5$ValidAphiaID==126792 & dat5$newLngtClass==95]
#dat5$QC_Length[dat5$New_UniqueID=="NS-IBTS/2016/1/SCO3/46/GOV" &
#                 dat5$ValidAphiaID==126792 & dat5$newLngtClass==95]<-"Length/10"
find<-dat5[dat5$New_UniqueID=="NS-IBTS/2000/1/WAH3/59/GOV" &
             dat5$ValidAphiaID==126928 & dat5$newLngtClass==55]
dat5$QC_Length[dat5$New_UniqueID=="NS-IBTS/2000/1/WAH3/59/GOV" &
                 dat5$ValidAphiaID==126928 & dat5$newLngtClass==55]<-"Length/10"

dat5$LMax1.1<-dat5$LmaxFB*1.1
# if lenght is more than 1.4 lmax and change to 1.1 Lmax 
summary(as.factor(dat5$QC_Length))
dat5$Use_Lenght_cm[dat5$QC_Length=="Length/10"]<- dat5$newLngtClass_10[dat5$QC_Length=="Length/10"]
#dat5$Use_Lenght_cm[dat5$QC_Length=='Lmax+40%']<- dat5$LMax1.4[dat5$QC_Length=='Lmax+40%']

summary(dat5$Use_Lenght_cm)
#list<-c('Length_changed(DP)', 'no_change','Species&Lenght_changed(DP)',
#        'Species_changed(DP)', 'Species_changed_to_genus(DP)' )
#dat5$Use_Lenght_cm[dat5$QC_Length%in%list]<- dat5$newLngtClass[dat5$QC_Length%in%list]
#summary(dat5$Use_Lenght_cm)
# have we got them all now?
test1 <- dat5[ which(dat5$Use_Lenght_cm > dat5$LmaxFB*1.1),]
# still 2049 oversized fish getting closer
test2<-dat5[ which(dat5$Use_Lenght_cm > dat5$LmaxFB*1.4),]
# 1747 are within criteria for "big fish" and can be accepted as such
# 302 the fish are still "too big" based on lmax
# combination of missidentifications, poor estimate of Lmax and possibly 
# lenght problems???
summary(as.factor(test2$ValidAphiaID))
dat5$LmaxFB[dat5$ValidAphiaID==126662]<-NA
dat5$LmaxFB[dat5$ValidAphiaID==126642]<-NA
dat5$LmaxFB[dat5$ValidAphiaID==126752]<-NA
dat5$LmaxFB[dat5$ValidAphiaID==126751]<-NA
dat5$LmaxFB[dat5$ValidAphiaID==126756]<-NA
# Echiodon dentatus:Lmax is potentially strange, so Ill leave records as is
# Notacanthus bonaparte:Lmax is potentially strange,  so Ill leave records as is
# all Ammodytes are going to family level so not messing with the recorded lenghts
test1 <- dat5[which(dat5$Use_Lenght_cm > dat5$LmaxFB*1.1),]
# still 2028 oversized fish getting closer
test2<-dat5[which(dat5$Use_Lenght_cm > dat5$LmaxFB*1.4),]
test2<-subset(test2, QC_Length=="no_change",)
test2<-subset(test2, !family=="Gobiidae",)
# now that leaves 268 to look at
plot(dat5$Use_Lenght_cm[dat5$ValidAphiaID==105851], 
     dat5$HLNoAtLngt[dat5$ValidAphiaID==105851],
     pch=19, col="green")

# change oversized Taurulus bubalis to Myoxocephalus scorpius in line 
# with DP decisions
names(dat5)
dat5$estAphia_Code[dat5$ValidAphiaID==127204&
                         dat5$newLngtClass>24.5]<-127203  
dat5$estsciname[dat5$ValidAphiaID==127204&
                  dat5$newLngtClass>24.5]<-"Myoxocephalus scorpius"
dat5$QC_Length[dat5$ValidAphiaID==127204&
                 dat4$newLngtClass>24.5]<-"Species_changed(DP)"

find<-dat5[dat5$New_UniqueID=="NIGFS/2007/4/CO/19/ROT" &
             dat5$ValidAphiaID==126417 & dat5$newLngtClass==935]
dat5$QC_Length[dat5$New_UniqueID=="NIGFS/2007/4/CO/19/ROT" &
                 dat5$ValidAphiaID==126417 & dat5$newLngtClass==935]<-"Length/10"

dat5$Use_Lenght_cm[dat5$QC_Length=="Length/10"]<- dat5$newLngtClass_10[dat5$QC_Length=="Length/10"]
#dat5$Use_Lenght_cm[dat5$QC_Length=='Lmax+40%']<- dat5$LMax1.4[dat5$QC_Length=='Lmax+40%']

summary(dat5$Use_Lenght_cm)
#list<-c('Length_changed(DP)', 'no_change','Species&Lenght_changed(DP)',
#        'Species_changed(DP)', 'Species_changed_to_genus(DP)' )
#dat5$Use_Lenght_cm[dat5$QC_Length%in%list]<- dat5$newLngtClass[dat5$QC_Length%in%list]
#summary(dat5$Use_Lenght_cm)
test2<-dat5[ which(dat5$Use_Lenght_cm > dat5$LmaxFB*1.4),]
test2<-subset(test2, QC_Length=="no_change",)
test2<-subset(test2, !family=="Gobiidae",)

dat5$QC_Length[(dat5$Use_Lenght_cm > dat5$LmaxFB*1.4) & 
                 dat5$QC_Length=="no_change" & !dat5$family=="Gobiidae"]<-"length_unrelibable"

dat5$Use_Lenght_cm1<-as.numeric(dat5$Use_Lenght_cm)
dat5$LMax1.1<-as.numeric(dat5$LMax1.1)
summary(dat5$Use_Lenght_cm1)
dat5$Use_Lenght_cm1[dat5$QC_Length=="length_unrelibable"]<-dat5$LMax1.1[dat5$QC_Length=="length_unrelibable"]
# all spp above the max lenght now gone
# replaced using 1.1Lmax
summary(dat5$Use_Lenght_cm1)
dat5$Use_Lenght_cm1[is.na(dat5$Use_Lenght_cm1)]<-0
summary(dat5$Use_Lenght_cm1)
test2<-dat5[which(dat5$Use_Lenght_cm1 > dat5$LmaxFB*1.4),]
summary(as.factor(test2$estsciname))
write.csv(dat5, "Species_data_lngt_checked_10_10_2016.csv")
##############
# Check Lmin #
##############
names(traits)
names(dat5)
traits$estsciname<-traits$valid_name
dat5$LmaxFB<-NULL
dat5$valid_name<-NULL
dat5$valid_authority<-NULL
dat5$kingdom<-NULL
dat5$phylum<-NULL
dat5$order<-NULL
dat5$family<-NULL
dat5$genus<-NULL
dat5$rank<-NULL
dat5$FRS_Common.Name<-NULL
dat5$CLASS<-NULL
dat5$Lmin<-NULL
dat5$LMax1.4<-NULL
dat5$LMax1.1<-NULL
dat5$LWRa<-NULL
dat5$LWRb<-NULL
# new data frame
dat6<-join(dat5, traits, by="estsciname")
names(dat6)
# have we got them all now?
test1 <- dat6[ which(dat6$Use_Lenght_cm1 > dat6$LmaxFB*1.1),]
test2<-dat6[ which(dat6$Use_Lenght_cm1 > dat6$LmaxFB*1.4),]
dat6$Use_Lenght_cm1[dat6$FishLength_cm==171&dat6$valid_name=="Ammodytidae"]<-17.5
dat6$QC_Length[which(dat6$Use_Lenght_cm1 > dat6$LmaxFB*1.4)]<-"length_unrelibable"
summary(as.factor(dat6$QC_Length))
dat6$Lmax1.1<-dat6$LmaxFB*1.1
dat6$Use_Lenght_cm1[dat6$QC_Length=="length_unrelibable"]<-dat6$Lmax1.1[dat6$QC_Length=="length_unrelibable"]
test2<-dat6[ which(dat6$Use_Lenght_cm1 > dat6$LmaxFB*1.4),]
dat6$QC_Length[dat6$QC_Length=="length_unrelibable"]<-"Lmax+10%"
# now Lmin 
# Is length less that 0.9 time species known Lmin
test1<-dat6[which(dat6$Use_Lenght_cm1 < dat6$Lmin*0.9),]
# I don't believe some of these Lmins - larger than L max!
dat6$Lmin[dat6$estsciname=="Petromyzon marinus"]<-1.35
dat6$Lmin[dat6$estsciname=="Lampetra fluviatilis"]<-1.3
test1<-dat6[which(dat6$Use_Lenght_cm1 < dat6$Lmin*0.9),]
summary(as.factor(test1$estsciname))
summary(dat6$Lmin)
summary(test1$Use_Lenght_cm1)
test1<-subset(test1, !Use_Lenght_cm1==0,)
summary(test1$family)
test1<-dat6[which(dat6$Use_Lenght_cm1 < dat6$Lmin*0.9),]
test1<-subset(test1, !Use_Lenght_cm1==0,)
dat$QC_Length[which(dat6$Use_Lenght_cm1 < dat6$Lmin*0.9)]
test2<-dat6[which(dat6$Use_Lenght_cm1 < dat6$Lmin*0.5),]
test2<-subset(test2, !Use_Lenght_cm1==0,)
dat6$QC_Length[which(dat6$Use_Lenght_cm1 < dat6$Lmin*0.9)]<-"Questionalble_Lmin"
summary(test2$Use_Lenght_cm1)

dat6$QC_Length[dat6$Use_Lenght_cm1==0]<-"No_Len_Data"
summary(as.factor(dat6$QC_Length))
###########################
# Lengths - Catch Weights #
###########################
dat6$CatCatchWgt_N<-as.numeric(dat6$CatCatchWgt)
summary(dat6$CatCatchWgt_N)
dat6$CatCatchWgt_N[is.na(dat6$CatCatchWgt_N)]<-0
dat6$CatCatchWgt_N[dat6$CatCatchWgt_N==-9000]<-9000
dat6$NewCatCatchWgt[dat6$DataType=="R"]<-dat6$CatCatchWgt_N[dat6$DataType=="R"]
dat6$NewCatCatchWgt[dat6$DataType=="S"]<-dat6$CatCatchWgt_N[dat6$DataType=="S"]
dat6$NewCatCatchWgt[dat6$DataType=="C"]<-(dat6$CatCatchWgt_N[dat6$DataType=="C"])/60*dat6$HaulDur[dat6$DataType=="C"]
dat6$CatCatchWgt_per_km2<-dat6$NewCatCatchWgt/dat6$SweptArea_wing_km_sqrd
summary(dat6$NewCatCatchWgt)
summary(dat6$CatCatchWgt_per_km2)
exp((log(9000)-log(.03))/3)

dat6$fish_len_est_catch_weight<-exp((log(dat6$NewCatCatchWgt)-log(dat6$LWRa))/dat6$LWRb)
dat6$fish_len_est_catch_weight_round<-floor(dat6$fish_len_est_catch_weight)
summary(dat6$fish_len_est_catch_weight_round)
dat6$FishLength_cm_below<-floor(dat6$Use_Lenght_cm1)

summary(as.factor(dat6$QC_Length))
list<-c("Length/10","Lmax+10%","No_Len_Data", "Questionalble_Lmin")
LFDab<-subset(dat6, QC_Length%in%list&NewTotalNo<2, )
# If Length is missing or questionable then replace where possible with a 
# lenght dervied using the LWR a and b paramaters
dat6$FishLength_cm_below[dat6$QC_Length%in%list&dat6$NewTotalNo<2&!dat6$fish_len_est_catch_weight==0]<-dat6$fish_len_est_catch_weight_round[dat6$QC_Length%in%list&dat6$NewTotalNo<2&!dat6$fish_len_est_catch_weight==0]
dat6$QC_Length[dat6$QC_Length%in%list&dat6$NewTotalNo<2&!dat6$fish_len_est_catch_weight==0]<-"Lenght_Weight_Relationship"
# check wee fish
find<-subset(dat6, dat6$FishLength_cm_below<3,)
# remove the 0 lengths
find1<-subset(find, !FishLength_cm_below==0,)
# 1377 observations of small fish
summary(as.factor(find1$QC_Length))
# all BTS could get 1 - 2cm fish - accept these records
find2<-subset(find1, !Survey=="BTS",)
find2<-subset(find2, !Survey=="BTS-VIIa",)
# leaves 1077 records
summary(as.factor(find2$estsciname))
# Gobiidae and Caprosaper are okay
find2<-subset(find2, !estsciname=="Gobiidae",)
find2<-subset(find2, !estsciname=="Capros aper",)

# Coelorinchuscaelorhincus
# find2<-subset(find2, !SciName=="Coelorinchus caelorhincus",)
# Maurolicusmuelleri are really little fish - accept these lenghts
find2<-subset(find2, !estsciname=="Maurolicus muelleri",)
# accept Argyropelecushemigymnus 2 cm not unheard of
find2<-subset(find2, !estsciname=="Argyropelecus hemigymnus",)
# accept Trachurustrachurus
find2<-subset(find2, !estsciname=="Trachurus trachurus",)
# accept all wee
# Smoothheads and Searsids (Alepocephalidae and Searsidae) - SL
# Grenadiers (Macrouridae)- PAFL  Pre Anal Fin Length
# Chimaeridae (Rabbitfish)  PSCFL  Pre Supra Caudal Fin Length
#find2<-subset(find2, !family=="Chimaeridae",)
#find2<-subset(find2, !family=="Macrouridae",)
#find2<-subset(find2, !family=="Alepocephalidae",)
#find2<-subset(find2, !family=="Searsidae",)
write.csv(find2, "Very_small_fish_11-10-2016.csv")
unique(as.factor(find2$family))
summary(as.factor(find2$SciName))
summary(find1$NewHLNoAtLngt)
check<-subset(dat6, dat6$New_UniqueID=="EVHOE/1997/4/THA2/76/GOV",)

check1<-subset(dat6, dat6$New_UniqueID=="EVHOE/2014/4/THA2/19/GOV")
find<-subset(dat6, dat6$estsciname=="Bathysolea profundicola" &
               FishLength_cm_below<5,)
# length code error - fix lengths
dat6$FishLength_cm_below[dat6$estsciname=="Bathysolea profundicola" &
                               dat6$FishLength_cm_below<5]<-dat6$LngtClass[dat6$estsciname=="Bathysolea profundicola" &
                                                                             dat6$FishLength_cm_below<5]

check1<-subset(dat6, dat6$New_UniqueID=="NS-IBTS/2006/1/THA2/59/GOV")
# corrections from DPS
# netherlands
dat6$FishLength_cm_below[dat6$estsciname=="Clupea harengus" &
                               dat6$New_UniqueID=="NS-IBTS/2000/1/TRI2/42/GOV" &
                               dat6$LngtClass==20]<-20
dat6$FishLength_cm_below[dat6$estsciname=="Clupea harengus" &
                               dat6$New_UniqueID=="NS-IBTS/2000/1/TRI2/8/GOV" &
                               dat6$LngtClass==25]<-25
dat6$FishLength_cm_below[dat6$estsciname=="Callionymus reticulatus" &
                               dat6$New_UniqueID=="NS-IBTS/2007/1/TRI2/5/GOV" &
                               dat6$LngtClass==2]<-12

# 2 corrections from scotland 
#NS-IBTS/2009/3/SCO3/1/GOV Agonuscataphractus 1 should be 15cm
find<-subset(dat6, dat6$estsciname=="Agonus cataphractus" &
               dat6$New_UniqueID=="NS-IBTS/2009/3/SCO3/1/GOV"&
               dat6$FishLength_cm_below==1,)

dat6$FishLength_cm_below[dat6$estsciname=="Agonus cataphractus" &
                               dat6$New_UniqueID=="NS-IBTS/2009/3/SCO3/1/GOV"&
                               dat6$FishLength_cm_below==1]<-15

#NS-IBTS/2001/1/SCO3/7/GOV Sardinapilchardus 1 should be 10cm
find<-subset(dat6, dat6$estsciname=="Sardina pilchardus" &
               dat6$New_UniqueID=="NS-IBTS/2001/1/SCO3/7/GOV"&
               dat6$FishLength_cm_below==1,)

dat6$FishLength_cm_below[dat6$estsciname=="Sardina pilchardus" &
                               dat6$New_UniqueID=="NS-IBTS/2001/1/SCO3/7/GOV"&
                               dat6$FishLength_cm_below==1]<-10
# 3 Sweden corrections

dat6$FishLength_cm_below[dat6$estsciname=="Trisopterus esmarkii" &
                               dat6$New_UniqueID=="NS-IBTS/2016/1/DANS/46/GOV"&
                               dat6$FishLength_cm_below==2]<-11


# NS-IBTS/1995/1/ARG/18/GOV	Platichthysflesus	should be 20

dat6$FishLength_cm_below[dat6$estsciname=="Platichthys flesus" &
                               dat6$New_UniqueID=="NS-IBTS/1995/1/ARG/18/GOV"&
                               dat6$FishLength_cm_below==2]<-20

# NS-IBTS/2007/3/ARG/33/GOV	Scophthalmusmaximus	should be 20
dat6$FishLength_cm_below[dat6$estsciname=="Scophthalmus maximus" &
                               dat6$New_UniqueID=="NS-IBTS/2007/3/ARG/33/GOV"&
                               dat6$FishLength_cm_below==2]<-20


# a very odd thing has happened with the use of length codes in this haul
find<-subset(dat6, dat6$estsciname=="Amblyraja radiata" &
               dat6$LngtCode=="."&dat6$Country=="FRA"&
               dat6$Survey=="NS-IBTS"&dat6$Year==2006,)
dat6$FishLength_cm_below[dat6$estsciname=="Amblyraja radiata" &
                               dat6$LngtCode=="."&
                               dat6$Country=="FRA"&
                               dat6$Survey=="NS-IBTS"&
                               dat6$Year==2006]<-dat6$LngtClass[dat6$estsciname=="Amblyraja radiata" &
                                                                          dat6$LngtCode=="." &
                                                                          dat6$Country=="FRA" &
                                                                          dat6$Survey=="NS-IBTS" &
                                                                          dat6$Year==2006]

# a very odd thing has happened with the use of length codes in this haul
find<-subset(dat6, dat6$estsciname=="Ciliata mustela" &
               dat6$LngtCode=="."&dat6$Country=="FRA"&
               dat6$Survey=="NS-IBTS"&dat6$Year==2006,)
dat6$FishLength_cm_below[dat6$estsciname=="Ciliata mustela" &
                               dat6$LngtCode=="."&
                               dat6$Country=="FRA"&
                               dat6$Survey=="NS-IBTS"&
                               dat6$Year==2006]<-dat6$LngtClass[dat6$estsciname=="Ciliata mustela" &
                                                                          dat6$LngtCode=="." &
                                                                          dat6$Country=="FRA" &
                                                                          dat6$Survey=="NS-IBTS" &
                                                                          dat6$Year==2006]
find<-subset(dat6, dat6$estsciname=="Alosa agone" &
               dat6$LngtCode=="0"&dat6$Country=="FRA"&
               dat6$Survey=="NS-IBTS"&dat6$FishLength_cm_below<5,)

dat6$FishLength_cm_below[dat6$estsciname=="Alosa agone" &
                               dat6$LngtCode=="0"&
                               dat6$Country=="FRA"&
                               dat6$Survey=="NS-IBTS"&
                               dat6$FishLength_cm_below<5]<-dat6$LngtClass[dat6$estsciname=="Alosa agone" &
                                                                                     dat6$LngtCode=="0" &
                                                                                     dat6$Country=="FRA" &
                                                                                     dat6$Survey=="NS-IBTS"&
                                                                                     dat6$FishLength_cm_below<5]

find<-subset(dat6, dat6$estsciname=="Alosa alosa" &
               dat6$LngtCode=="0"&dat6$Country=="FRA"&
               dat6$Survey=="NS-IBTS"&dat6$FishLength_cm_below<5,)

dat6$FishLength_cm_below[dat6$estsciname=="Alosa alosa" &
                               dat6$LngtCode=="0"&
                               dat6$Country=="FRA"&
                               dat6$Survey=="NS-IBTS"&
                               dat6$FishLength_cm_below<5]<-dat6$LngtClass[dat6$estsciname=="Alosa alosa" &
                                                                                     dat6$LngtCode=="0" &
                                                                                     dat6$Country=="FRA" &
                                                                                     dat6$Survey=="NS-IBTS"& dat6$FishLength_cm_below<5]
# nothing to suggest the Clupea harengus are wrong except mismatch with catch weights
find<-subset(dat6, dat6$estsciname=="Clupea harengus" & 
               dat6$Year==1985 & dat6$Country=="NOR",)
find<-subset(dat6, dat6$estsciname=="Clupea harengus" ,)
plot(find$FishLength_cm_below, find$HLNoAtLngtkm2)
find<-subset(dat6, dat6$estsciname=="Zeus faber" & 
               dat6$New_UniqueID=="SWC-IBTS/2003/1/SCO3/99/GOV" ,)

#Chelidonichthysobscurus
find<-subset(dat6, dat6$estsciname=="Trisopterus esmarkii" & 
               dat6$Year==2013 & dat6$Country=="NOR",)
plot(find$LngtClass, find$HLNoAtLngtkm2)
# really looks like some of the samples lost the 1 at the front of them

find<-subset(dat6, dat6$estsciname=="Squalus acanthias" & 
               dat6$New_UniqueID=="SWC-IBTS/2007/1/SCO3/64/GOV",)

plot(find$LngtClass, find$HLNoAtLngtkm2)
# let length = 1 equal length 0 and estimate sensible length
dat6$FishLength_cm_below[dat6$estsciname=="Squalus acanthias" &
                               dat6$LngtClass=="1"]<-0

# Rajaclavata
find<-subset(dat6, dat6$estsciname=="Raja clavata" & 
               dat6$New_UniqueID=="FR-CGFS/2003/4/GWD/62/GOV",)
# estimate the lenght
# let length = 1 equal length 0 and estimate sensible length
dat6$FishLength_cm_below[dat6$estsciname=="Raja clavata" &
                               dat6$New_UniqueID=="FR-CGFS/2003/4/GWD/62/GOV"&
                               dat6$Use_Lenght_cm=="10"]<-0


# poor cod
find<-subset(dat6, dat6$estsciname=="Trisopterus minutus" & 
               dat6$Survey=="ROCKALL",)
plot(find$FishLength_cm_below, find$HLNoAtLngtkm2, pch=19)

find<-subset(dat6, dat6$estsciname=="Sprattus sprattus" & 
               dat6$New_UniqueID=="NS-IBTS/1995/1/MIC/15/GOV",)
plot(find$FishLength_cm_below, find$HLNoAtLngtkm2, pch=19)
# should be 12	NS-IBTS/1995/1/MIC/15/GOV
dat6$FishLength_cm_below[dat6$estsciname=="Sprattus sprattus" &
                               dat6$New_UniqueID=="NS-IBTS/1995/1/MIC/15/GOV"&
                               dat6$Use_Lenght_cm=="1"]<-12


#range 10-39 cm, length code error	NS-IBTS/1995/1/MIC/23/GOV
dat6$FishLength_cm_below[dat6$estsciname=="Micromesistius poutassou" &
                               dat6$New_UniqueID=="NS-IBTS/1995/1/MIC/23/GOV"&
                               dat6$Use_Lenght_cm=="1.5"]<-15
find<-subset(dat6, dat6$estsciname=="Micromesistius poutassou" & 
               dat6$New_UniqueID=="NS-IBTS/1995/1/MIC/23/GOV",)


# range 13-35 cm, length code error	NS-IBTS/1995/1/MIC/31/GOV
find<-subset(dat6, dat6$estsciname=="Micromesistius poutassou" & 
               dat6$New_UniqueID=="NS-IBTS/1995/1/MIC/31/GOV",)
dat6$FishLength_cm_below[dat6$estsciname=="Micromesistius poutassou" &
                               dat6$New_UniqueID=="NS-IBTS/1995/1/MIC/31/GOV"&
                               dat6$Use_Lenght_cm=="1.5"]<-15


# Copy the working file
write.csv(dat6, "dat6_workingHL_11-10-2016.csv")
#
dat6<-read.csv("dat6_workingHL_11-10-2016.csv")
find<-subset(dat6, dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/44/GOV")

dat6$FishLength_cm_below[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/44/GOV"&
                           dat6$estsciname=="Spinachia spinachia"&
                           dat6$Filter=="LFD"]<-19
dat6$Filter[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/44/GOV"&
              dat6$estsciname=="Spinachia spinachia"&
              dat6$FishLength_cm_below==19]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/43/GOV"&
                           dat6$estsciname=="Spinachia spinachia"&
                           dat6$Filter=="LFD"]<-17
dat6$Filter[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/43/GOV"&
              dat6$estsciname=="Spinachia spinachia"&
              dat6$FishLength_cm_below==17]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/42/GOV"&
                           dat6$estsciname=="Spinachia spinachia"&
                           dat6$Filter=="LFD"]<-14
dat6$Filter[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/42/GOV"&
              dat6$estsciname=="Spinachia spinachia"&
              dat6$FishLength_cm_below==14]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/34/GOV"&
                           dat6$estsciname=="Spinachia spinachia"&
                           dat6$Filter=="LFD"]<-15
dat6$Filter[dat6$New_UniqueID=="NS-IBTS/2005/1/DAN2/34/GOV"&
            dat6$estsciname=="Spinachia spinachia"&
            dat6$FishLength_cm_below==15]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="NS-IBTS/2004/3/DAN2/43/GOV"&
                         dat6$estsciname=="Spinachia spinachia"&
                         dat6$Filter=="LFD"]<-18
dat6$Filter[dat6$New_UniqueID=="NS-IBTS/2004/3/DAN2/43/GOV"&
            dat6$estsciname=="Spinachia spinachia"&
            dat6$FishLength_cm_below==18]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="NS-IBTS/2004/3/DAN2/40/GOV"&
                         dat6$estsciname=="Spinachia spinachia"&
                         dat6$Filter=="LFD"]<-20
dat6$Filter[dat6$New_UniqueID=="NS-IBTS/2004/3/DAN2/40/GOV"&
            dat6$estsciname=="Spinachia spinachia"&
            dat6$FishLength_cm_below==20]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="NS-IBTS/2004/3/DAN2/38/GOV"&
                         dat6$estsciname=="Spinachia spinachia"&
                         dat6$Filter=="LFD"]<-20
dat6$Filter[dat6$New_UniqueID=="NS-IBTS/2004/3/DAN2/38/GOV"&
            dat6$estsciname=="Spinachia spinachia"&
            dat6$FishLength_cm_below==20]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="NIGFS/2007/4/CO/29/ROT"&
                         dat6$estsciname=="Phrynorhombus norvegicus"&
                         dat6$Filter=="LFD"]<-7
dat6$Filter[dat6$New_UniqueID=="NIGFS/2007/4/CO/29/ROT"&
            dat6$estsciname=="Phrynorhombus norvegicus"&
            dat6$FishLength_cm_below==7]<-"OK"
dat6$FishLength_cm_below[dat6$New_UniqueID=="EVHOE/2015/4/THA2/46/GOV"&
                         dat6$estsciname=="Merlangius merlangus"&
                         dat6$Filter=="LFD"]<-37
dat6$Filter[dat6$New_UniqueID=="EVHOE/2015/4/THA2/46/GOV"&
            dat6$estsciname=="Merlangius merlangus"&
            dat6$FishLength_cm_below==37]<-"OK"
# Syngnathus rostellatus which is more likely to be S. acus based on size
list<-c("BTS/2004/3/COR/100/BT4","BTS/2006/3/COR/37/BT4","BTS/2006/3/COR/39/BT4")

dat6$estsciname[dat6$HaulID%in%list&dat6$estsciname=="Syngnathus rostellatus"
                &dat6$FishLength_cm_below>24]<-"Syngnathus acus"
dat6$estAphia_Code[dat6$HaulID%in%list&dat6$estsciname=="Syngnathus rostellatus"
                   &dat6$FishLength_cm_below>24]<-"127387"
dat6$Filter[dat6$HaulID%in%list&dat6$estsciname=="Syngnathus rostellatus"
            &dat6$FishLength_cm_below>24]<-"OK"

# Echiichthys vipera should be Trachinus draco
dat6$estsciname[dat6$estsciname=="Echiichthys vipera"&
                  dat6$estAphia_Code==150630&
                  dat6$FishLength_cm_below>22.5]<-"Trachinus draco"
dat6$QC_Length[dat6$FishLength_cm_below==150630&
                 dat6$newLngtClass>22.5]<-"Species_changed"
dat6$estAphia_Code[dat6$estAphia_Code==150630&
                     dat6$FishLength_cm_below>22.5]<-127082  
# Lepadogaster at 20cm - should be 2cm
dat6$FishLength_cm_below[dat6$FishLength_cm==20&
                           dat6$estsciname=="Lepadogaster lepadogaster"]<-2
###################
# ADD  FLITER FOR #
# BASELINE        #
###################
summary(dat6$Density_Km2)

summary(as.factor(dat6$SpeciesQualityCode))
list<-c('Genus_to_spp',  'Recorded_Data', 'Family_to_spp', 'Species_changed')
dat6$Filter[dat6$SpeciesQualityCode%in%list]<-"OK"
dat6$Filter[!dat6$SpeciesQualityCode%in%list]<-"SC"
dat6$Filter[dat6$FishLength_cm_below=="0"&dat6$estrank=="Species"]<-"LFD"
dat6$Filter[dat6$FishLength_cm_below=="0"&dat6$estrank=="Genus"]<-"SCLFD"
dat6$Filter[dat6$FishLength_cm_below=="0"&dat6$estrank=="Family"]<-"SCLFD"
dat6$Filter[dat6$estsciname=="Gobiidae"&!dat6$FishLength_cm_below=="0"]<-"OK"
dat6$Filter[dat6$estsciname=="Ammodytidae"&!dat6$FishLength_cm_below=="0"]<-"OK"
dat6$Filter[dat6$estsciname=="Gobiidae"&dat6$FishLength_cm_below=="0"]<-"LFD"
dat6$Filter[dat6$estsciname=="Ammodytidae"&dat6$FishLength_cm_below=="0"]<-"LFD"
names(dat6)
dat6$Filter[dat6$FishLength_cm_below=="0"&dat6$Density_Km2=="0"&dat6$TotalNoKm2==0]<-"CatchWeight"
summary(as.factor(dat6$Filter))
###########################
# 4.2.4 Abundance of Fish #
###########################
# Plot Summed Biomass at Lenght for a species in a hauls
# against Reported Catch Weight
names(dat6)
# Some columns could be removed to make the file more managable
dat6$FRS_Common.Name<-NULL
dat6$kingdom<-NULL
dat6$phylum<-NULL
dat6$CLASS<-NULL
dat6$valid_authority<-NULL
dat6$SweptArea_wing_m_sqrd<-NULL
dat6$HaulVal<-NULL
summary((dat6$FishLength_cm_below))
summary(dat6$LWRa)

dat7<-subset(dat6, !is.na(LWRa)&!is.na(LWRb)&!LWRa==0&!LWRb==0&!CatCatchWgt_per_km2==0&!HLNoAtLngtkm2==0&!FishLength_cm_below==0,)           
names(dat7)
summary(as.factor(dat7$Filter))
summary(dat7$FishLength_cm_below)
dat7$X.1<-NULL
dat7$X<-NULL
dat7$ValidAphiaID.1<-NULL                 
dat7$LWRa<-NULL
dat7$ValidAphiaID.2<-NULL
dat7$valid_name<-NULL
dat7$order<-NULL
dat7$family<-NULL
dat7$genus<-NULL
dat7$rank<-NULL
dat7$LmaxFB<-NULL
dat7$LWRa.1<-NULL
dat7$LWRb<-NULL
dat7$Lmin<-NULL
dat7$Lmax1.1<-NULL                        
dat7.1<-merge(dat7, traits, by="ValidAphiaID")
names(dat7.1)
summary(dat7.1$FishLength_cm_below)
summary(dat7.1$Density_Km2)
Weight_Check<-ddply(dat7.1, c("New_UniqueID", "Survey", "Country",
                            "Year", "estsciname", "HLNoAtLngtkm2", 
                            "FishLength_cm_below", "CatCatchWgt_per_km2", 
                            "CatIdentifier"),
                       summarise, EstimatedWeight=sum(LWRa*FishLength_cm_below^LWRb))
write.csv(Weight_Check, "Summary_weights_lengths_15-110-2016.csv")
summaryweight<-ddply(Weight_Check, c("New_UniqueID", "Survey", "Country",
                                     "Year", "estsciname","CatCatchWgt_per_km2",
                                     "CatIdentifier"),
                                      summarise, 
                                      EstimatedCatchWeight=sum(as.numeric(EstimatedWeight*HLNoAtLngtkm2)))
summaryweight1<-ddply(summaryweight, c("New_UniqueID", "Survey", "Country",
                                     "Year", "estsciname","EstimatedCatchWeight"),      
                     summarise, AggCatCatchWgt_per_km2=sum(CatCatchWgt_per_km2))

write.csv(summaryweight, "Summary_Fish_CatchWeight.csv")
write.csv(summaryweight1, "Summary1_Fish_CatchWeight.csv")
summary(summaryweight1$AggCatCatchWgt_per_km2)
summaryweight1<-subset(summaryweight1, !is.na(AggCatCatchWgt_per_km2),)
summaryweight1<-subset(summaryweight1, !(AggCatCatchWgt_per_km2==0),)
summaryweight1<-subset(summaryweight1, !is.na(EstimatedCatchWeight),)
summaryweight1<-subset(summaryweight1, !(EstimatedCatchWeight==0),)
plot(summaryweight1$CatCatchWgt_per_km2, summaryweight1$EstimatedCatchWeight, pch=19)

for (cat in unique(summaryweight1$estsciname)){
  mypath <- file.path(paste("Weight_Check_", cat, ".jpeg", sep = ""))
  jpeg(file=mypath)
    d <- subset(summaryweight1, estsciname == cat)
    plot(d$AggCatCatchWgt_per_km2, d$EstimatedCatchWeight, 
       main=unique(d$estsciname), pch=19, xlab="Recorded Catch Weight (g/Km2)", 
       ylab="Estimated Catch Weight (g/Km2)")
    abline(0,1, col="red")
    abline(0,0.75, col='red', lty=2)
    abline(0,1.25, col='red', lty=2)
  dev.off()
}

# Plot Summed Densities at lenght against reported Catch weight
Weight_Check1<-ddply(dat7, c("New_UniqueID", "Survey", "Country",
                             "Year", "estsciname", "CatCatchWgt_per_km2", 
                             "TotalNoKm2", "CatIdentifier" ),
                      summarise, SummedHLNoLng=sum(HLNoAtLngtkm2))

Weight_Check2<-ddply(Weight_Check1, c("New_UniqueID", "Survey", "Country",
                                      "Year", "estsciname",  
                                      "TotalNoKm2", "SummedHLNoLng" ),
                     summarise, SummedCatCatchWgt=sum(CatCatchWgt_per_km2))

Weight_Check1<-subset(Weight_Check1, !is.na(CatCatchWgt_per_km2),)
Weight_Check1<-subset(Weight_Check1, !(CatCatchWgt_per_km2==0),)
Weight_Check1<-subset(Weight_Check1, !is.na(SummedHLNoLng),)
Weight_Check1<-subset(Weight_Check1, !(SummedHLNoLng==0),)

write.csv(Weight_Check1, "Weight_Density_Checks.csv")

plot(Weight_Check1$CatCatchWgt_per_km2, Weight_Check1$SummedHLNoLng)
summary(as.factor(Weight_Check1$Survey))

for (cat in unique(Weight_Check2$estsciname)){
  mypath <- file.path(paste("Density_at_Weight_Check_", cat, ".jpeg", sep = ""))
  jpeg(file=mypath)
  d <- subset(Weight_Check2, estsciname == cat)
  plot(d$SummedCatCatchWgt, d$SummedHLNoLng, 
       main=unique(d$estsciname), pch=19, xlab="Recorded Catch Weight (g/Km2)", 
       ylab="Density (no/km2)")
  dev.off()
}

# plot Lenght frequency distributions per species per counrty per year.
for (cat in unique(dat6$estsciname)){
  mypath <- file.path(paste("Length_Frequency_", cat, ".jpeg", sep = ""))
  jpeg(file=mypath)
  d <- subset(dat6, estsciname == cat)
  plot(d$FishLength_cm_below, d$HLNoAtLngtkm2, 
       main=unique(d$estsciname), pch=19, xlab="Length (cm)", 
       ylab="Density at Lenght (km2)")
  dev.off()
}
##############################
# Change CatchWeights to LFD #
##############################
find<-subset(dat6, dat6$Filter=="CatchWeight",)
dat7<-subset(dat6, !(dat6$Filter=="CatchWeight"&is.na(dat6$CatCatchWgt)),)
nrow(dat6)-nrow(dat7)
find<-subset(dat7, dat7$Filter=="CatchWeight",)
list<-unique(as.factor(dat7$estsciname[dat7$Filter=="CatchWeight"]))
find<-subset(dat7, dat7$Density_Km2==0,)

meancatchweight<-ddply(summaryweight1,
                       c("Survey", "Country","Year", "estsciname"),      
                        summarise, meanAggCatCatchWgt_per_km2=mean(AggCatCatchWgt_per_km2))
meancatchweight1<-subset(meancatchweight, meancatchweight$estsciname%in%list,)
list<-unique(as.factor(dat7$Year[dat7$Filter=="CatchWeight"]))
meancatchweight1<-subset(meancatchweight1, meancatchweight1$Year%in%list,)
list<-unique(as.factor(dat7$Survey[dat7$Filter=="CatchWeight"]))
meancatchweight1<-subset(meancatchweight1, meancatchweight1$Survey%in%list,)

write.csv(find, "Catch_Weight_only_11-10-2016.csv")
write.csv(meancatchweight, "mean_catchweight-11-10-2016.csv")
find<-subset(dat7, Filter=="CatchWeight",)
# Fix Catch weights
summary(as.factor(dat7$Filter))
ceiling(268456.3758/283215.5222)
1/0.017284
summary(dat7$Density_Km2)
dat7$Filter[dat7$Density_Km2==0]<-"CatchWeight"
summary(as.factor(dat7$Filter))
# Scyliorhinus canicula 2002
dat7$Density_Km2[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/24/BT4A"&
               dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-57.85698
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/24/BT4A"&
                 dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-57.85698
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/24/BT4A"&
                     dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-105
dat7$Filter[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/24/BT4A"&
                           dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-"0K"
# Scyliorhinus canicula
50447.2512769591/22478.960064874
2/0.0475348
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2014/4/NOR/61/NCT"&
                 dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-42.07444
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2014/4/NOR/61/NCT"&
                     dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-42.07444
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2014/4/NOR/61/NCT"&
                           dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-89
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2014/4/NOR/61/NCT"&
              dat7$estsciname=="Scyliorhinus canicula"&dat7$Filter=="CatchWeight"]<-"0K"
#Syngnathidae
7619.90139/778.508066614135
10/0.008924
dat7$Density_Km2[dat7$New_UniqueID=="BTS/2015/3/END/55/BT4A"&
                 dat7$estsciname=="Syngnathidae"&dat7$Filter=="CatchWeight"]<-1120.574
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS/2015/3/END/55/BT4A"&
                     dat7$estsciname=="Syngnathidae"&dat7$Filter=="CatchWeight"]<-1120.574
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS/2015/3/END/55/BT4A"&
                           dat7$estsciname=="SSyngnathidae"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="BTS/2015/3/END/55/BT4A"&
              dat7$estsciname=="Syngnathidae"&dat7$Filter=="CatchWeight"]<-"SCLFD"
#Conger conger
25792.7239485665/12283.83003
2/0.0447413
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/17/NCT"&
                 dat7$estsciname=="Conger conger"&dat7$Filter=="CatchWeight"]<-44.70143
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/17/NCT"&
                     dat7$estsciname=="Conger conger"&dat7$Filter=="CatchWeight"]<-44.70143
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/17/NCT"&
                           dat7$estsciname=="Conger conger"&dat7$Filter=="CatchWeight"]<-86
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/17/NCT"&
              dat7$estsciname=="Conger conger"&dat7$Filter=="CatchWeight"]<-"0K"
# Trisopterus esmarkii  NS-IBTS/2011/3/JHJ/301/GOV
236.7954889/117938.5798
#1 fish ?
1/0.067568855
dat7$Density_Km2[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/301/GOV"&
                 dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-14.79972
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/301/GOV"&
                     dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-14.79972
dat7$FishLength_cm_below[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/301/GOV"&
                           dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-12
dat7$Filter[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/301/GOV"&
              dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-"0K"
# Trisopterus esmarkii NS-IBTS/2011/3/JHJ/260/GOV
1380.359397/117938.5798
#1 fish?
1/0.062676914
dat7$Density_Km2[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/260/GOV"&
                 dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-15.95484
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/260/GOV"&
                     dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-15.95484
dat7$FishLength_cm_below[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/260/GOV"&
                           dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-21
dat7$Filter[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/260/GOV"&
              dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-"0K"
# Trisopterus luscus BTS-VIIa/2002/3/COR/8/BT4A
12462.61216/35414.47696
# 1 Fish
1/0.016048
dat7$Density_Km2[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/8/BT4A"&
                 dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-62.31306
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/8/BT4A"&
                     dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-62.31306
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/8/BT4A"&
                           dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-23
dat7$Filter[dat7$New_UniqueID=="BTS-VIIa/2002/3/COR/8/BT4A"&
              dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-"0K"
# Trisopterus luscus PT-IBTS/2013/4/NOR/47/NCT
32710.2699295729/68232.24859
1/0.0447413
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/47/NCT"&
                 dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-22.35071
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/47/NCT"&
                     dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-22.35071
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/47/NCT"&
                           dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-43
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2013/4/NOR/47/NCT"&
              dat7$estsciname=="Trisopterus luscus"&dat7$Filter=="CatchWeight"]<-"0K"
# Scomber scombrus PT-IBTS/2008/3/NOR/81/NCT
33.6845226583415/244739.3541
1/0.0223631
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2008/3/NOR/81/NCT"&
                 dat7$estsciname=="Scomber scombrus"&dat7$Filter=="CatchWeight"]<-44.71652
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2008/3/NOR/81/NCT"&
                     dat7$estsciname=="Scomber scombrus"&dat7$Filter=="CatchWeight"]<-44.71652
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2008/3/NOR/81/NCT"&
                           dat7$estsciname=="Scomber scombrus"&dat7$Filter=="CatchWeight"]<-33
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2008/3/NOR/81/NCT"&
              dat7$estsciname=="Scomber scombrus"&dat7$Filter=="CatchWeight"]<-"0K"

# Boops boops PT-IBTS/2006/3/NOR/7/NCT
117111.0489/76370.49092
2/0.0503283
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/7/NCT"&
                 dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-39.73907
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/7/NCT"&
                     dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-39.73907
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/7/NCT"&
                           dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/7/NCT"&
              dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-"0K"

# Boops boops  PT-IBTS/2010/4/NOR/12/NCT
29044.75283/116611.0045
1/0.0503283
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
                 dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-19.86954
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
                     dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-19.86954
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
                           dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-49
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
              dat7$estsciname=="Boops boops"&dat7$Filter=="CatchWeight"]<-"0K"

# Spondyliosoma cantharus  PT-IBTS/2009/4/NOR/72/NCT
37951.14316/64202.09959
1/0.0475348
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2009/4/NOR/72/NCT"&
                 dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-21.03722
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2009/4/NOR/72/NCT"&
                     dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-21.03722
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2009/4/NOR/72/NCT"&
                           dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-54
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2009/4/NOR/72/NCT"&
              dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-"0K"

# Spondyliosoma cantharus  PT-IBTS/2010/4/NOR/12/NCT
82027.12036/64202.09959
1/0.0447413
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
                 dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-22.35071
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
                     dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-22.35071
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
                           dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-68
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2010/4/NOR/12/NCT"&
              dat7$estsciname=="Spondyliosoma cantharus"&dat7$Filter=="CatchWeight"]<-"0K"

# Trachinus draco BTS-VIIa/2014/3/END/134/BT4A
11784.7411444142/21951.93821
1/0.01468
dat7$Density_Km2[dat7$New_UniqueID=="BTS-VIIa/2014/3/END/134/BT4A"&
                 dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-68.11989
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS-VIIa/2014/3/END/134/BT4A"&
                     dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-68.11989
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS-VIIa/2014/3/END/134/BT4A"&
                           dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-23
dat7$Filter[dat7$New_UniqueID=="BTS-VIIa/2014/3/END/134/BT4A"&
              dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-"0K"

# Trachinus draco BTS/2013/3/END/108/BT4A
1344.430218/32855.76347
1/0.01562
dat7$Density_Km2[dat7$New_UniqueID=="BTS/2013/3/END/108/BT4A"&
                 dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-64.02049
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS/2013/3/END/108/BT4A"&
                     dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-64.02049
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS/2013/3/END/108/BT4A"&
                           dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-11
dat7$Filter[dat7$New_UniqueID=="BTS/2013/3/END/108/BT4A"&
              dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-"0K"

# Trachinus draco BTS/2013/3/END/25/BT4A
5264.543301/32855.76347
1/0.015196

dat7$Density_Km2[dat7$New_UniqueID=="BTS/2013/3/END/25/BT4A"&
                 dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-65.80679
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS/2013/3/END/25/BT4A"&
                     dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-65.80679
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS/2013/3/END/25/BT4A"&
                           dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-18
dat7$Filter[dat7$New_UniqueID=="BTS/2013/3/END/25/BT4A"&
              dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-"0K"

# Trachinus draco  BTS/2013/3/END/2/BT4A
3584.743332/32855.76347
1/0.013948
dat7$Density_Km2[dat7$New_UniqueID=="BTS/2013/3/END/2/BT4A"&
                 dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-71.69487
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS/2013/3/END/2/BT4A"&
                     dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-71.69487
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS/2013/3/END/2/BT4A"&
                           dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-15
dat7$Filter[dat7$New_UniqueID=="BTS/2013/3/END/2/BT4A"&
              dat7$estsciname=="Trachinus draco"&dat7$Filter=="CatchWeight"]<-"0K"

# Lepidopus caudatus PT-IBTS/2006/3/NOR/15/NCT
317912.586/111309.5422
3/0.0503283
dat7$Density_Km2[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/15/NCT"&
                 dat7$estsciname=="Lepidopus caudatus"&dat7$Filter=="CatchWeight"]<-19.86954
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/15/NCT"&
                     dat7$estsciname=="Lepidopus caudatus"&dat7$Filter=="CatchWeight"]<-19.86954
dat7$FishLength_cm_below[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/15/NCT"&
                           dat7$estsciname=="Lepidopus caudatus"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="PT-IBTS/2006/3/NOR/15/NCT"&
              dat7$estsciname=="Lepidopus caudatus"&dat7$Filter=="CatchWeight"]<-"LFD"

# Hippoglossoides platessoides NS-IBTS/2011/3/JHJ/249/GOV
3479.014221/3564.508492
1/0.056164826

dat7$Density_Km2[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/249/GOV"&
                 dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-17.80474
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/249/GOV"&
                     dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-17.80474
dat7$FishLength_cm_below[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/249/GOV"&
                           dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-28
dat7$Filter[dat7$New_UniqueID=="NS-IBTS/2011/3/JHJ/249/GOV"&
              dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-"0K"

# Limanda limanda BTS/2003/3/SOL/23/BT7
1385289.75/2585.386748
536/0.0263952
dat7$Density_Km2[dat7$New_UniqueID=="BTS/2003/3/SOL/23/BT7"&
                 dat7$estsciname=="Limanda limanda"&dat7$Filter=="CatchWeight"]<-20306.72
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="BTS/2003/3/SOL/23/BT7"&
                     dat7$estsciname=="Limanda limanda"&dat7$Filter=="CatchWeight"]<-20306.72
dat7$FishLength_cm_below[dat7$New_UniqueID=="BTS/2003/3/SOL/23/BT7"&
                           dat7$estsciname=="Limanda limanda"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="BTS/2003/3/SOL/23/BT7"&
              dat7$estsciname=="Limanda limanda"&dat7$Filter=="CatchWeight"]<-"LFD"

1/0.04944979
dat7$Density_Km2[dat7$New_UniqueID=="NIGFS/2001/4/LF/33/ROT"&
                   dat7$estsciname=="Gobiidae"&dat7$Filter=="CatchWeight"]<-20.22253
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NIGFS/2001/4/LF/33/ROT"&
                     dat7$estsciname=="Gobiidae"&dat7$Filter=="CatchWeight"]<-20.22253
dat7$FishLength_cm_below[dat7$New_UniqueID=="NIGFS/2001/4/LF/33/ROT"&
                           dat7$estsciname=="Gobiidae"&dat7$Filter=="CatchWeight"]<-10
dat7$Filter[dat7$New_UniqueID=="NIGFS/2001/4/LF/33/ROT"&
              dat7$estsciname=="Gobiidae"&dat7$Filter=="CatchWeight"]<-"0K"
1/0.04909500
dat7$Density_Km2[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
                   dat7$estsciname=="Osmerus eperlanus"&dat7$Filter=="CatchWeight"]<-20.36867
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
                     dat7$estsciname=="Osmerus eperlanus"&dat7$Filter=="CatchWeight"]<-20.36867
dat7$FishLength_cm_below[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
                           dat7$estsciname=="Osmerus eperlanus"&dat7$Filter=="CatchWeight"]<-8
dat7$Filter[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
              dat7$estsciname=="Osmerus eperlanus"&dat7$Filter=="CatchWeight"]<-"0K"

dat7$Density_Km2[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
                   dat7$estsciname=="Alosa agone"&dat7$Filter=="CatchWeight"]<-20.36867
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
                     dat7$estsciname=="Alosa agone"&dat7$Filter=="CatchWeight"]<-20.36867
dat7$FishLength_cm_below[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
                           dat7$estsciname=="Alosa agone"&dat7$Filter=="CatchWeight"]<-8
dat7$Filter[dat7$New_UniqueID=="NS-IBTS/2012/1/THA2/58/GOV"&
              dat7$estsciname=="Alosa agone"&dat7$Filter=="CatchWeight"]<-"0K"
1/0.08594431
dat7$Density_Km2[dat7$New_UniqueID=="NIGFS/2004/1/LF/20/ROT"&
                   dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-11.63544
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NIGFS/2004/1/LF/20/ROT"&
                     dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-11.63544
dat7$FishLength_cm_below[dat7$New_UniqueID=="NIGFS/2004/1/LF/20/ROT"&
                           dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-39
dat7$Filter[dat7$New_UniqueID=="NIGFS/2004/1/LF/20/ROT"&
              dat7$estsciname=="Hippoglossoides platessoides"&dat7$Filter=="CatchWeight"]<-"0K"

summary(dat7$Density_Km2)
# NIGFS/2007/1/CO/10/ROT Callionymus maculatus
77/936.296272*100
8/0.07590857
dat7$Density_Km2[dat7$New_UniqueID=="NIGFS/2007/1/CO/10/ROT"&
                   dat7$estsciname=="Callionymus maculatus"&dat7$Filter=="CatchWeight"]<-105.3899
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NIGFS/2007/1/CO/10/ROT"&
                     dat7$estsciname=="Callionymus maculatus"&dat7$Filter=="CatchWeight"]<-105.3899
dat7$FishLength_cm_below[dat7$New_UniqueID=="NIGFS/2007/1/CO/10/ROT"&
                           dat7$estsciname=="Callionymus maculatus"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="NIGFS/2007/1/CO/10/ROT"&
              dat7$estsciname=="Callionymus maculatus"&dat7$Filter=="CatchWeight"]<-"LFD"


#NIGFS/2006/4/CO/1/ROT Sprattus sprattus
9760/678379.4712		*100
1/0.0227783
#		Sprattus sprattus
dat7$Density_Km2[dat7$New_UniqueID=="NIGFS/2006/4/CO/1/ROT"&
                   dat7$estsciname=="Sprattus sprattus"&dat7$Filter=="CatchWeight"]<-43.90143
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NIGFS/2006/4/CO/1/ROT"&
                     dat7$estsciname=="Sprattus sprattus"&dat7$Filter=="CatchWeight"]<-43.90143
dat7$FishLength_cm_below[dat7$New_UniqueID=="NIGFS/2006/4/CO/1/ROT"&
                           dat7$estsciname=="Sprattus sprattus"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="NIGFS/2006/4/CO/1/ROT"&
              dat7$estsciname=="Sprattus sprattus"&dat7$Filter=="CatchWeight"]<-"LFD"

#NIGFS/2003/1/LF/21/ROT Trisopterus esmarkii
34959/172535.0079*100
20/0.08768564
#2003		Trisopterus esmarkii
dat7$Density_Km2[dat7$New_UniqueID=="NIGFS/2003/1/LF/21/ROT"&
                   dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-228.0875
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NIGFS/2003/1/LF/21/ROT"&
                     dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-228.0875
dat7$FishLength_cm_below[dat7$New_UniqueID=="NIGFS/2003/1/LF/21/ROT"&
                           dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="NIGFS/2003/1/LF/21/ROT"&
              dat7$estsciname=="Trisopterus esmarkii"&dat7$Filter=="CatchWeight"]<-"LFD"
#NIGFS/2003/1/LF/11/ROT Platichthys flesus
11430/192406.4217*100
6/0.08140275
#2003		Platichthys flesus
dat7$Density_Km2[dat7$New_UniqueID=="NIGFS/2003/1/LF/11/ROT"&
                   dat7$estsciname=="Platichthys flesus"&dat7$Filter=="CatchWeight"]<-73.70758
dat7$HLNoAtLngtkm2[dat7$New_UniqueID=="NIGFS/2003/1/LF/11/ROT"&
                     dat7$estsciname=="Platichthys flesus"&dat7$Filter=="CatchWeight"]<-73.70758
dat7$FishLength_cm_below[dat7$New_UniqueID=="NIGFS/2003/1/LF/11/ROT"&
                           dat7$estsciname=="Platichthys flesus"&dat7$Filter=="CatchWeight"]<-0
dat7$Filter[dat7$New_UniqueID=="NIGFS/2003/1/LF/11/ROT"&
              dat7$estsciname=="Platichthys flesus"&dat7$Filter=="CatchWeight"]<-"0K"


summary(dat7$Density_Km2)
summary(dat7$HLNoAtLngtkm2)
summary(dat7$HLNoAtLngt_N)
##################################################
# Check inconistent abundances and catch weights #
##################################################
summary(dat7$fish_len_est_catch_weight)
names(dat7)
dat7$Derived_Indiv_Fish_weight_At_Lng<-dat7$LWRa*(dat7$FishLength_cm_below^dat7$LWRb)
summary(dat7$Derived_Indiv_Fish_weight_At_Lng)
dat7$Derived_Indiv_Fish_weight_At_Lng[dat7$Derived_Indiv_Fish_weight_At_Lng==0]<-NA

summary(dat7$Density_Km2)
summary(dat7$TotalNoKm2)
summary(dat7$CatCatchWgt_per_km2)
dat7$TotalNo_km2_derived_from_weight<-dat7$CatCatchWgt_per_km2/dat7$Derived_Indiv_Fish_weight_At_Lng
dat7$Difference_in_total_weight<-dat7$TotalNoKm2-dat7$TotalNo_km2_derived_from_weight
dat7$Difference_in_Density_weight<-sqrt((dat7$Density_Km2-dat7$TotalNo_km2_derived_from_weight)^2)

summary(dat7$TotalNo_km2_derived_from_weight)
summary(dat7$TotalNoKm2)
summary(dat7$Difference_in_Density_weight)
summary(dat7$Difference_in_total_weight)

boxplot(dat7$Difference_in_total_weight~dat7$Survey)

ggplot(dat7, aes(x=CatCatchWgt_per_km2, y=TotalNo_km2_derived_from_weight, colour=Survey))+
  geom_jitter()

ggplot(dat7, aes(x=TotalNoKm2, y=TotalNo_km2_derived_from_weight, colour=Survey))+
  geom_jitter()


find<-subset(dat7, dat7$Difference_in_total_weight>1000000,)
summary(as.factor(find$Survey))
########
find<-subset(dat7, Density_Km2==0,)
find<-subset(dat7, dat7$HLNoAtLngtkm2>dat7$TotalNoKm2)
summary(dat7$Density_Km2)
#summary(dat7$Density_Km21)
#Weight_Check<-ddply(dat7, c("New_UniqueID", "Survey", "Country",
#                            "Year", "estsciname", "Density_Km21", 
##                            "FishLength_cm_below", "CatCatchWgt_per_km2", 
#                            "CatIdentifier"),
#                    summarise, EstimatedWeight=sum(LWRa*FishLength_cm_below^LWRb))
#write.csv(Weight_Check, "Summary_weights_lengths_10-10-2016.csv")
#summaryweight<-ddply(Weight_Check, c("New_UniqueID", "Survey", "Country",
#                                     "Year", "estsciname","CatCatchWgt_per_km2",
#                                     "CatIdentifier"),
#                     summarise, 
#                     EstimatedCatchWeight=sum(as.numeric(EstimatedWeight*Density_Km21)))
#summaryweight1<-ddply(summaryweight, c("New_UniqueID", "Survey", "Country",
#                                       "Year", "estsciname","EstimatedCatchWeight"),      
#                      summarise, AggCatCatchWgt_per_km2=sum(CatCatchWgt_per_km2))

#write.csv(summaryweight, "Summary_Fish_CatchWeight_corrections1.csv")
#write.csv(summaryweight1, "Summary1_Fish_CatchWeight_corrections1.csv")
#summary(summaryweight1$AggCatCatchWgt_per_km2)
#summaryweight1<-subset(summaryweight1, !is.na(AggCatCatchWgt_per_km2),)
#summaryweight1<-subset(summaryweight1, !(AggCatCatchWgt_per_km2==0),)
#summaryweight1<-subset(summaryweight1, !is.na(EstimatedCatchWeight),)
#summaryweight1<-subset(summaryweight1, !(EstimatedCatchWeight==0),)
#plot(summaryweight1$CatCatchWgt_per_km2, summaryweight1$EstimatedCatchWeight, pch=19)

#for (cat in unique(summaryweight1$estsciname)){
  mypath <- file.path(paste("C1_Weight_Check_", cat, ".jpeg", sep = ""))
  jpeg(file=mypath)
  d <- subset(summaryweight1, estsciname == cat)
  plot(d$AggCatCatchWgt_per_km2, d$EstimatedCatchWeight, 
       main=unique(d$estsciname), pch=19, xlab="Recorded Catch Weight (g/Km2)", 
       ylab="Estimated Catch Weight (g/Km2)")
  abline(0,1, col="red")
  abline(0,0.75, col='red', lty=2)
  abline(0,1.25, col='red', lty=2)
  dev.off()
}

# Plot Summed Densities at lenght against reported Catch weight
#Weight_Check1<-ddply(dat7, c("New_UniqueID", "Survey", "Country",
#                             "Year", "estsciname", "CatCatchWgt_per_km2", 
#                             "TotalNoKm2", "CatIdentifier" ),
#                     summarise, SummedHLNoLng=sum(Density_Km21))

#Weight_Check2<-ddply(Weight_Check1, c("New_UniqueID", "Survey", "Country",
 #                                     "Year", "estsciname",  
 #                                     "TotalNoKm2", "SummedHLNoLng" ),
 #                    summarise, SummedCatCatchWgt=sum(CatCatchWgt_per_km2))

#Weight_Check1<-subset(Weight_Check1, !is.na(CatCatchWgt_per_km2),)
#Weight_Check1<-subset(Weight_Check1, !(CatCatchWgt_per_km2==0),)
#Weight_Check1<-subset(Weight_Check1, !is.na(SummedHLNoLng),)
#Weight_Check1<-subset(Weight_Check1, !(SummedHLNoLng==0),)

#write.csv(Weight_Check1, "Weight_Density_Checks_c1.csv")

#plot(Weight_Check1$CatCatchWgt_per_km2, Weight_Check1$SummedHLNoLng)
#summary(as.factor(Weight_Check1$Survey))

#for (cat in unique(Weight_Check2$estsciname)){
  mypath <- file.path(paste("C1_Density_at_Weight_Check_", cat, ".jpeg", sep = ""))
  jpeg(file=mypath)
  d <- subset(Weight_Check2, estsciname == cat)
  plot(d$SummedCatCatchWgt, d$SummedHLNoLng, 
       main=unique(d$estsciname), pch=19, xlab="Recorded Catch Weight (g/Km2)", 
       ylab="Density (no/km2)")
  dev.off()
}

# plot Lenght frequency distributions per species per counrty per year.
for (cat in unique(dat7$estsciname)){
  mypath <- file.path(paste("C2_Length_Frequency_", cat, ".jpeg", sep = ""))
  jpeg(file=mypath)
  d <- subset(dat7, estsciname == cat)
  plot(d$FishLength_cm_below, d$Density_Km22, 
       main=unique(d$estsciname), pch=19, xlab="Length (cm)", 
       ylab="Density at Lenght (km2)")
  dev.off()
}

#summary(dat7$Density_Km21)
#dat7$Density_Km22<-dat7$Density_Km21
#dat7$Density_Km22[dat7$Density_Km21==0]<-dat7$HLNoAtLngtkm2[dat7$Density_Km21==0]
#summary(dat7$Density_Km22)
################
# Check Filter #
################
summary(dat7$Density_Km2)

summary(as.factor(dat7$estrank))
list<-c("Species", "Subspecies")
dat7$Filter[dat7$estrank%in%list]<-"OK"
dat7$Filter[!dat7$estrank%in%list]<-"SC"
dat7$Filter[dat7$FishLength_cm_below=="0"&dat7$estrank=="Species"]<-"LFD"
dat7$Filter[dat7$FishLength_cm_below=="0"&dat7$estrank=="Subspecies"]<-"LFD"
dat7$Filter[dat7$FishLength_cm_below=="0"&dat7$estrank=="Genus"]<-"SCLFD"
dat7$Filter[dat7$FishLength_cm_below=="0"&dat7$estrank=="Family"]<-"SCLFD"
dat7$Filter[dat7$estsciname=="Notoscopelus kroyeri"&!dat7$FishLength_cm_below=="0"]<-"OK"
dat7$Filter[dat7$estsciname=="Gobiidae"&!dat7$FishLength_cm_below=="0"]<-"OK"
dat7$Filter[dat7$estsciname=="Ammodytidae"&!dat7$FishLength_cm_below=="0"]<-"OK"
dat7$Filter[dat7$estsciname=="Gobiidae"&dat7$FishLength_cm_below=="0"]<-"LFD"
dat7$Filter[dat7$estsciname=="Ammodytidae"&dat7$FishLength_cm_below=="0"]<-"LFD"

summary(as.factor(dat7$Filter))

summary(as.factor(dat7$estsciname[dat7$Filter=="SC"]))
summary(as.factor(dat7$estsciname[dat7$Filter=="SCLFD"]))
summary(as.factor(dat7$estsciname[dat7$Filter=="LFD"]))
####################################
# All checks now complete for fish #
# next step is to remove all fish  #
# less than 2 cm                   #
####################################
smallfish<-subset(dat7, FishLength_cm_below<3&!FishLength_cm_below==0,)
summary(smallfish$FishLength_cm_below)
summary(dat7$FishLength_cm_below)
summary(dat7$HLNoAtLngt_N)
names(dat7)
summary(dat7$TotalNo_N)
summary(dat7$HLNoAtLngtkm2)
summary(dat7$TotalNoKm2)
write.csv(smallfish, "Small_fish_removed_from_DP_12-10-2016.csv")
dat8<-subset(dat7, FishLength_cm_below>2|FishLength_cm_below==0,)
dat8$LmaxFB

test1<-dat8[which(dat8$FishLength_cm_below > dat8$LmaxFB*1.1),]
# 1962 observations 

test2<-dat8[which(dat8$FishLength_cm_below > dat8$LmaxFB*1.4),]
summary(as.factor(dat8$FishLength_cm_below[dat8$estsciname=="Lepadogaster lepadogaster"]))

write.csv(dat8, "dat8_HL_16-11-2016.csv")

dat8<-read.csv("dat8_HL_08-11-2016.csv")
memory.size(10000000000000)
names(dat8)
summary(dat8$FishLength_cm_below)
summary(dat8$HLNoAtLngt_N)
names(dat8)

dat8$X.1<-NULL
dat8$X<-NULL                            
dat8$ValidAphiaID.1<-NULL
dat8$LWRa<-NULL                            
dat8$ValidAphiaID.2<-NULL                  
dat8$valid_name<-NULL
dat8$order<-NULL                         
dat8$family<-NULL
dat8$genus<-NULL                           
dat8$rank<-NULL
dat8$LmaxFB<-NULL                          
dat8$LWRa.1<-NULL
dat8$LWRb<-NULL                          
dat8$Lmin<-NULL
dat8$Lmax1.1<-NULL                        
summary(as.factor(dat8$estsciname))
names(traits)
traits$estsciname<-traits$valid_name
dat8_1<-merge(dat8,traits, by="estsciname")
nrow(dat8)-nrow(dat8_1)
dat8_1$LmaxFB[dat8_1$valid_name=="Torpedo nobiliana"]<-180
dat8_1$LmaxFB[dat8_1$valid_name=="Urophycis chuss"]<-66
dat8_1$LmaxFB[dat8_1$valid_name=="Howella sherborni"]<-8

test1<-dat8_1[which(dat8_1$FishLength_cm_below > dat8_1$LmaxFB*1.1),]
# 1962 observations 

dat8_1$estsciname[dat8_1$estsciname=="Callionymus risso"&dat8_1$FishLength_cm_below>15]<-"Callionymus"
dat8_1$estrank[dat8_1$estsciname=="Callionymus"]<-"Genus"
dat8_1$LmaxFB[dat8_1$estsciname=="Callionymus"]<-30

test2<-dat8_1[which(dat8_1$FishLength_cm_below > dat8_1$LmaxFB*1.4),]
dat8_1$FishLength_cm_below[dat8_1$FishLength_cm_below > dat8_1$LmaxFB*1.4]<-0
diff<-test2$newLngtClass-test2$FishLength_cm_below
summary(dat8_1$FishLength_cm_below[dat8_1$estsciname=="Limanda limanda"])
